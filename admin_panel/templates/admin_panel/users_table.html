{% extends 'admin_panel/base.html' %}

{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - MLM Admin Panel{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
        <a href="{% url 'admin_panel:add_user' %}" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</a>
    </div>
    <div class="card-body">
        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="d-flex mb-2" style="gap: 1rem;">
            <div class="form-group mb-0" style="flex: 1;">
                <input type="text" class="form-control" id="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, username, email..." value="{{ search }}">
            </div>
            <div class="form-group mb-0">
                <select class="form-control" id="status-filter">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="participant" {% if status == 'participant' %}selected{% endif %}>–£—á–∞—Å—Ç–Ω–∏–∫</option>
                    <option value="partner" {% if status == 'partner' %}selected{% endif %}>–ü–∞—Ä—Ç–Ω–µ—Ä</option>
                </select>
            </div>
            <div class="form-group mb-0">
                <select class="form-control" id="rank-filter">
                    <option value="">–í—Å–µ —Ä–∞–Ω–≥–∏</option>
                    <option value="0" {% if rank == "0" %}selected{% endif %}>–†–∞–Ω–≥ 0</option>
                    <option value="1" {% if rank == "1" %}selected{% endif %}>–ü–£1</option>
                    <option value="2" {% if rank == "2" %}selected{% endif %}>–ü–£2</option>
                    <option value="3" {% if rank == "3" %}selected{% endif %}>–ü–£3</option>
                    <option value="4" {% if rank == "4" %}selected{% endif %}>–ü–£4</option>
                    <option value="5" {% if rank == "5" %}selected{% endif %}>–ü–£5</option>
                    <option value="6" {% if rank == "6" %}selected{% endif %}>–ü–£6</option>
                    <option value="7" {% if rank == "7" %}selected{% endif %}>–ü–£7</option>
                    <option value="8" {% if rank == "8" %}selected{% endif %}>–ü–£8</option>
                    <option value="9" {% if rank == "9" %}selected{% endif %}>–ü–£9</option>
                    <option value="10" {% if rank == "10" %}selected{% endif %}>–ü–£10</option>
                </select>
            </div>
            <button class="btn" onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div style="overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="select-all">
                        </th>
                        <th>–ë–∞–ª–∞–Ω—Å</th>
                        <th>–ó–∞–∫–∞–∑—ã</th>
                        <th>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å</th>
                        <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                        <th>–ü–∞—Ä—Ç–Ω–µ—Ä 1–≥–æ —É—Ä–æ–≤–Ω—è</th>
                        <th>–ü–∞—Ä—Ç–Ω–µ—Ä 2–≥–æ —É—Ä–æ–≤–Ω—è</th>
                        <th>–ü–∞—Ä—Ç–Ω–µ—Ä 3–≥–æ —É—Ä–æ–≤–Ω—è</th>
                        <th>–ü–æ–∫—É–ø–∫–∏ (—Å—É–º–º–∞)</th>
                        <th>–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è</th>
                        <th>–í—ã–ø–ª–∞—Ç—ã</th>
                        <th>–û—Å—Ç–∞–ª–æ—Å—å –≤—ã–ø–ª–∞—Ç–∏—Ç—å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>
                            <input type="checkbox" name="selected_users" value="{{ user.id }}">
                        </td>
                        <td class="{% if user.balance > 0 %}text-success{% endif %}">
                            {{ user.balance|floatformat:2 }} PZ
                        </td>
                        <td>
                            {{ user.total_purchases|floatformat:2 }} PZ {{ user.partners_level_1|add:user.partners_level_2|add:user.partners_level_3 }} —à—Ç
                        </td>
                        <td>
                            {% if user.inviter %}
                                @{{ user.inviter.username }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div style="width: 30px; height: 30px; border-radius: 50%; background-color: #007bff; color: white; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold;">
                                    {{ user.first_name|first|default:user.username|first|upper }}
                                </div>
                                {{ user.get_full_name }} @{{ user.username }}
                            </div>
                        </td>
                        <td>{{ user.partners_level_1 }}</td>
                        <td>{{ user.partners_level_2 }}</td>
                        <td>{{ user.partners_level_3 }}</td>
                        <td>{{ user.total_purchases|floatformat:2 }} PZ</td>
                        <td>{{ user.total_rewards|floatformat:2 }} PZ</td>
                        <td>{{ user.total_payouts|floatformat:2 }} PZ</td>
                        <td>{{ user.remaining_payout|floatformat:2 }} PZ</td>
                        <td>
                            <div class="d-flex" style="gap: 5px;">
                                <button class="btn btn-sm" style="background: green; color: white;" onclick="viewUser({{ user.id }})" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                                    üìÑ
                                </button>
                                <button class="btn btn-sm" style="background: blue; color: white;" onclick="editUser({{ user.id }})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                    üëÅ
                                </button>
                                <button class="btn btn-sm" style="background: blue; color: white;" onclick="refreshUser({{ user.id }})" title="–û–±–Ω–æ–≤–∏—Ç—å">
                                    üîÑ
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="13" class="text-center text-muted">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞ -->
<div id="paymentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; min-width: 400px;">
        <h3>–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞</h3>
        <form id="paymentForm">
            <input type="hidden" id="payment-user-id" name="user_id">
            <div class="form-group">
                <label>–°—É–º–º–∞ (PZ)</label>
                <input type="number" class="form-control" name="amount" step="0.01" min="0" required>
            </div>
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-danger" onclick="closePaymentModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-success">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–ª–∞—Ç–µ–∂</button>
            </div>
        </form>
    </div>
</div>

<script>
function applyFilters() {
    const search = document.getElementById('search').value;
    const status = document.getElementById('status-filter').value;
    const rank = document.getElementById('rank-filter').value;
    
    const params = new URLSearchParams();
    if (search) params.append('search', search);
    if (status) params.append('status', status);
    if (rank) params.append('rank', rank);
    
    window.location.href = '{% url "admin_panel:users_table" %}?' + params.toString();
}

function viewUser(userId) {
    window.open('{% url "admin_panel:user_detail" 0 %}'.replace('0', userId), '_blank');
}

function editUser(userId) {
    window.open('/admin/users/user/' + userId + '/change/', '_blank');
}

function refreshUser(userId) {
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    location.reload();
}

function processPayment(userId) {
    document.getElementById('payment-user-id').value = userId;
    document.getElementById('paymentModal').style.display = 'block';
}

function closePaymentModal() {
    document.getElementById('paymentModal').style.display = 'none';
    document.getElementById('paymentForm').reset();
}

document.getElementById('paymentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('{% url "admin_panel:process_payment" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!');
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞: ' + error);
    });
});

// –í—ã–±–æ—Ä –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
document.getElementById('select-all').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('input[name="selected_users"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
    });
});
</script>
{% endblock %}
