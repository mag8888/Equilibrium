<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ v2 ‚Äî –°–µ—Ç–∫–∞, –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: #1f2937; }
        .toolbar { position: fixed; top: 10px; left: 10px; z-index: 1000; }
        .menu-dropdown { display: none; position: absolute; top: calc(100% + 8px); left: 0; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); min-width: 250px; max-height: 80vh; overflow-y: auto; padding: 12px; border: 1px solid #e5e7eb; }
        .menu-dropdown.show { display: block; }
        .menu-section { margin-bottom: 16px; }
        .menu-section:last-child { margin-bottom: 0; }
        .menu-title { font-size: 11px; font-weight: 600; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid #e5e7eb; }
        .menu-btn { width: 100%; margin-bottom: 6px; text-align: left; justify-content: flex-start; padding: 8px 12px; }
        .menu-btn:last-child { margin-bottom: 0; }
        .menu-btn:hover { background: #f3f4f6; }
        .stats-panel { position: fixed; top: 10px; right: 10px; z-index: 1000; background: rgba(255,255,255,0.95); padding: 12px 16px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); min-width: 200px; }
        .stats-title { font-weight: 600; margin-bottom: 8px; font-size: 14px; color: #333; }
        .stats-item { display: flex; justify-content: space-between; padding: 4px 0; font-size: 13px; border-bottom: 1px solid #eee; }
        .stats-item:last-child { border-bottom: none; }
        .stats-level { color: #666; }
        .stats-count { font-weight: 600; color: #2563eb; }
        .btn { padding: 6px 10px; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; color: #1f2937; font-weight: 500; }
        .btn:hover { background: #f3f4f6; }
        .viewport { position: relative; width: 100vw; height: 100vh; overflow: hidden; background: #fafafa; }
        .canvas { position: absolute; top: 0; left: 0; width: 6500px; height: 8450px; transform-origin: 0 0; }
        .grid { position: absolute; inset: 0; background-image: linear-gradient(#eee 1px, transparent 1px), linear-gradient(90deg, #eee 1px, transparent 1px); background-size: 40px 40px, 40px 40px; pointer-events: none; }
        .grid.heavy { background-image: linear-gradient(#eee 1px, transparent 1px), linear-gradient(90deg, #eee 1px, transparent 1px), linear-gradient(#e2e8f0 1px, transparent 1px), linear-gradient(90deg, #e2e8f0 1px, transparent 1px); background-size: 40px 40px, 40px 40px, 200px 200px, 200px 200px; }
        .links { position: absolute; inset: 0; pointer-events: none; }
        .link-path { fill: none; stroke: #2563eb; stroke-width: 4; opacity: 0.9; }
        .link-shadow { fill: none; stroke: rgba(37,99,235,0.25); stroke-width: 8; }
        .card { position: absolute; min-width: 140px; min-height: 64px; padding: 10px 12px; background: white; border: 2px solid #cbd5e1; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); cursor: grab; user-select: none; transition: box-shadow 0.15s ease; color: #1f2937; }
        .card:hover { box-shadow: 0 6px 18px rgba(0,0,0,0.1); }
        .card.dragging { cursor: grabbing; z-index: 2000; }
        .card .badge { 
            position: absolute; 
            bottom: -10px; 
            left: -10px; 
            background: #1f2937; 
            color: #fff; 
            font-size: 12px; 
            font-weight: 600;
            padding: 4px 8px; 
            border-radius: 8px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            z-index: 20;
            min-width: 24px;
            text-align: center;
        }
        .card .badge.level-up {
            background: #22c55e;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .card .progress-indicator {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #e5e7eb;
            border-radius: 0 0 8px 8px;
        }
        .card .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #22c55e);
            border-radius: 0 0 8px 8px;
            transition: width 0.3s ease;
        }
        .card .name { font-weight: 600; color: #1f2937; }
        .card .uid { font-size: 12px; opacity: 0.6; color: #4b5563; }
        .card .delete-btn { position: absolute; top: -8px; right: -8px; width: 20px; height: 20px; background: #ef4444; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; z-index: 10; line-height: 1; }
        .card:hover .delete-btn { opacity: 1; }
        .card .delete-btn:hover { background: #dc2626; }
        .card .fill-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; z-index: 10; display: none; }
        .card.empty .fill-btn { display: block; }
        .card.empty .name, .card.empty .uid { display: none; }
        .card.empty { border-style: dashed; opacity: 0.7; }
        .card .fill-children-btn { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; z-index: 10; white-space: nowrap; }
        .card .fill-children-btn:hover { background: #059669; }
        .card .fill-children-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .card .add-child-btn { position: absolute; top: -8px; left: -8px; width: 24px; height: 24px; background: #10b981; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 16px; font-weight: 600; z-index: 10; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(0,0,0,0.15); opacity: 0; transition: opacity 0.2s; line-height: 1; }
        .card:hover .add-child-btn { opacity: 1; }
        .card .add-child-btn:hover { background: #059669; }
        .card .add-child-btn:disabled { opacity: 0.3; cursor: not-allowed; background: #9ca3af; }
        .point { position: absolute; width: 12px; height: 12px; border-radius: 50%; background: #22c55e; border: 2px solid #16a34a; top: 50%; transform: translateY(-50%); cursor: pointer; }
        .point.left { left: -8px; }
        .point.right { right: -8px; }
        .point.disabled { background: #e5e7eb; border-color: #cbd5e1; cursor: not-allowed; }
        .guide-line { position: absolute; left: 0; width: 100%; height: 2px; background: #ef4444; cursor: ns-resize; z-index: 1500; opacity: 0.7; }
        .guide-line:hover { opacity: 1; background: #dc2626; }
        .guide-line::before { content: ''; position: absolute; left: 0; top: -4px; width: 100%; height: 10px; cursor: ns-resize; }
        .guide-line-vertical { position: absolute; top: 0; width: 2px; height: 100%; background: #ef4444; cursor: ew-resize; z-index: 1500; opacity: 0.7; }
        .guide-line-vertical:hover { opacity: 1; background: #dc2626; }
        .guide-line-vertical::before { content: ''; position: absolute; top: 0; left: -4px; width: 10px; height: 100%; cursor: ew-resize; }
    </style>
</head>
<body>
    <div class="toolbar">
        <button class="btn" id="menuToggle" style="background: #6366f1; color: white; font-weight: 600;">‚ò∞ –ú–µ–Ω—é</button>
        <div class="menu-dropdown" id="menuDropdown">
            <div class="menu-section">
                <div class="menu-title">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
                <button class="btn menu-btn" id="toggleGrid">–°–∫—Ä—ã—Ç—å —Å–µ—Ç–∫—É</button>
                <button class="btn menu-btn" id="center">–¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn menu-btn" id="showAll" style="background: #3b82f6; color: white;">üîç –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
                <button class="btn menu-btn" id="showFullGrid" style="background: #f59e0b; color: white;">üìê –í—Å—è —Å–µ—Ç–∫–∞</button>
            </div>
            <div class="menu-section">
                <div class="menu-title">–ú–∞—Å—à—Ç–∞–±</div>
                <button class="btn menu-btn" id="snap">–ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Ç–∫–µ: –í–∫–ª</button>
                <button class="btn menu-btn" id="zoomOut">‚àí –£–º–µ–Ω—å—à–∏—Ç—å</button>
                <button class="btn menu-btn" id="zoomIn">+ –£–≤–µ–ª–∏—á–∏—Ç—å</button>
            </div>
            <div class="menu-section">
                <div class="menu-title">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</div>
                <button class="btn menu-btn" id="autoLayout" style="background: #6366f1; color: white;">üìê –†–∞—Å—Å—Ç–∞–≤–∏—Ç—å</button>
            </div>
            <div class="menu-section">
                <div class="menu-title">–ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç</div>
                <button class="btn menu-btn" id="importCoords" style="background: #06b6d4; color: white;">üì§ –ò–º–ø–æ—Ä—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç</button>
                <button class="btn menu-btn" id="exportCoords" style="background: #8b5cf6; color: white;">üì• –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç</button>
            </div>
            <div class="menu-section">
                <div class="menu-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</div>
                <button class="btn menu-btn" id="clearTestData" style="background: #f59e0b; color: white;">üßπ –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
                <button class="btn menu-btn" id="clearAll" style="background: #ef4444; color: white;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ—Ö</button>
                <button class="btn menu-btn" id="saveLayout" style="background: #10b981; color: white;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    <div class="stats-panel" id="statsPanel">
        <div class="stats-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—è–º</div>
        <div id="statsContent"></div>
    </div>
    <div class="viewport" id="viewport">
        <div class="canvas" id="canvas">
            <div class="grid heavy" id="grid"></div>
            <svg class="links" id="links" width="6500" height="8450"></svg>
            <!-- –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–µ –ª–∏–Ω–∏–∏-–æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã -->
            <div class="guide-line" style="top: 1000px;"></div>
            <div class="guide-line" style="top: 2500px;"></div>
            <div class="guide-line" style="top: 4000px;"></div>
            <div class="guide-line" style="top: 5500px;"></div>
            <div class="guide-line" style="top: 7000px;"></div>
            <!-- –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏-–æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã -->
            <div class="guide-line-vertical" style="left: 1000px;"></div>
            <div class="guide-line-vertical" style="left: 2000px;"></div>
            <div class="guide-line-vertical" style="left: 3000px;"></div>
            <div class="guide-line-vertical" style="left: 4000px;"></div>
            <div class="guide-line-vertical" style="left: 5000px;"></div>
            <!-- –ê–≤—Ç–æ-—Ä–∞—Å–∫–ª–∞–¥–∫–∞ –ø—Ä–∏–º–µ—Ä–∞ –ø–æ —É—Ä–æ–≤–Ω—è–º -->
            <div class="card" data-id="root" data-level="0" data-name="IVA" data-uid="0000001" style="left: 2400px; top: 200px;"></div>
        </div>
    </div>

    <script>
        const GRID_SIZE = 40;
        const viewport = document.getElementById('viewport');
        // –†–µ–Ω–¥–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∫–∞—Ä—Ç–æ—á–∫–∏ (–∏–º—è, id, –±–µ–π–¥–∂ —É—Ä–æ–≤–Ω—è)
        function renderCardContents(card) {
            const isRoot = card.dataset.id === 'root';
            const depth = parseInt(card.dataset.level || '0');
            // –í—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å–≤–æ–π —Ä–µ–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å (–≤–∫–ª—é—á–∞—è root)
            const displayLevel = depth;
            const isEmpty = !card.dataset.name || !card.dataset.uid;
            
            // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è
            const cardId = card.dataset.id;
            const partners = Array.from(canvas.querySelectorAll(`.card[data-parent="${cardId}"]`))
                .filter(child => child.dataset.name && child.dataset.uid);
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ –ø–æ —É—Ä–æ–≤–Ω—è–º
            const partnersByLevel = {};
            partners.forEach(partner => {
                const partnerLevel = parseInt(partner.dataset.level || '0');
                if (!partnersByLevel[partnerLevel]) {
                    partnersByLevel[partnerLevel] = [];
                }
                partnersByLevel[partnerLevel].push(partner);
            });
            
            // –ü–∞—Ä—Ç–Ω–µ—Ä—ã —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è
            const partnersAtCurrentLevel = partnersByLevel[depth] || [];
            const neededForNextLevel = Math.max(0, 3 - partnersAtCurrentLevel.length);
            const progressPercent = Math.min(100, (partnersAtCurrentLevel.length / 3) * 100);
            const canLevelUp = partnersAtCurrentLevel.length >= 3;
            
            // –ï—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ –ø—É—Å—Ç–∞—è, –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å empty
            if (isEmpty && !isRoot) {
                card.classList.add('empty');
            } else {
                card.classList.remove('empty');
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ–≤—ã—à–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è
            if (canLevelUp) {
                card.classList.add('can-level-up');
            } else {
                card.classList.remove('can-level-up');
            }
            
            if (isEmpty && !isRoot) {
                // –ü—É—Å—Ç–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –∫–Ω–æ–ø–∫—É "+"
                card.innerHTML = `
                    <div class="badge ${canLevelUp ? 'level-up' : ''}">${displayLevel}</div>
                    <button class="fill-btn" title="–ó–∞–ø–æ–ª–Ω–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∏ –µ—ë –¥–æ—á–µ—Ä–Ω–∏–µ –æ–±—ä–µ–∫—Ç—ã">–ó–∞–ø–æ–ª–Ω–∏—Ç—å</button>
                    <button class="add-child-btn" title="–î–æ–±–∞–≤–∏—Ç—å –¥–æ—á–µ—Ä–Ω–∏–π –æ–±—ä–µ–∫—Ç">+</button>
                    <button class="delete-btn" title="–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∏ –≤—Å–µ—Ö –µ—ë –¥–µ—Ç–µ–π">√ó</button>
                    ${!isEmpty ? `<div class="progress-indicator"><div class="progress-bar" style="width: ${progressPercent}%"></div></div>` : ''}
                `;
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                const fillBtn = card.querySelector('.fill-btn');
                if (fillBtn) {
                    fillBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        fillBtn.disabled = true;
                        fillBtn.textContent = '–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
                        await fillCard(card);
                        fillBtn.disabled = false;
                    });
                }
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "+"
                const addChildBtn = card.querySelector('.add-child-btn');
                if (addChildBtn) {
                    addChildBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        await fillNextChild(card);
                    });
                }
            } else {
                // –ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ - –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "+" –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ—á–µ—Ä–Ω–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤
                card.innerHTML = `
                    <div class="badge ${canLevelUp ? 'level-up' : ''}" title="–£—Ä–æ–≤–µ–Ω—å ${displayLevel}. –î–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –Ω—É–∂–Ω–æ ${neededForNextLevel > 0 ? `–µ—â–µ ${neededForNextLevel} –ø–∞—Ä—Ç–Ω–µ—Ä${neededForNextLevel === 1 ? '–∞' : '–æ–≤'}` : '–≥–æ—Ç–æ–≤ –∫ –ø–æ–≤—ã—à–µ–Ω–∏—é'}">${displayLevel}</div>
                    ${!isRoot ? '<button class="delete-btn" title="–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∏ –≤—Å–µ—Ö –µ—ë –¥–µ—Ç–µ–π">√ó</button>' : ''}
                    <button class="add-child-btn" title="–î–æ–±–∞–≤–∏—Ç—å –¥–æ—á–µ—Ä–Ω–∏–π –æ–±—ä–µ–∫—Ç">+</button>
                    <div class="name">${card.dataset.name}</div>
                    <div class="uid">ID${card.dataset.uid}</div>
                    ${partners.length > 0 ? `<div class="progress-indicator"><div class="progress-bar" style="width: ${progressPercent}%"></div></div>` : ''}
                `;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "+"
                const addChildBtn = card.querySelector('.add-child-btn');
                if (addChildBtn) {
                    addChildBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        await fillNextChild(card);
                    });
                }
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è
            if (!isRoot) {
                const deleteBtn = card.querySelector('.delete-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteCardAndChildren(card);
                    });
                }
            }
        }
        
        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–∞–Ω–Ω—ã–º–∏
        async function fillCard(card) {
            if (!card.dataset.name) card.dataset.name = generateRandomName();
            if (!card.dataset.uid) card.dataset.uid = generateRandomId();
            renderCardContents(card);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –≤ –±–∞–∑—É
            await saveCardToDatabase(card);
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ –æ–±—ä–µ–∫—Ç—ã —ç—Ç–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
            await fillCardChildren(card);
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
            recalculateLevel(card);
            
            savePositions();
            updateStats();
        }
        
        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–æ—á–µ—Ä–Ω–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –∫–∞—Ä—Ç–æ—á–∫–∏
        async function fillCardChildren(card) {
            const cardId = card.dataset.id;
            const children = Array.from(canvas.querySelectorAll(`.card[data-parent="${cardId}"]`));
            
            for (const child of children) {
                if (!child.dataset.name || !child.dataset.uid) {
                    await fillCard(child); // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –∑–∞–ø–æ–ª–Ω—è–µ–º –¥–æ—á–µ—Ä–Ω–∏–µ –æ–±—ä–µ–∫—Ç—ã
                }
            }
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –¥–æ—á–µ—Ä–Ω–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤
            recalculateLevel(card);
        }
        
        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –¥–æ—á–µ—Ä–Ω–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞ (–∏–ª–∏ –¥–æ—á–µ—Ä–Ω–µ–≥–æ –¥–æ—á–µ—Ä–Ω–µ–≥–æ –µ—Å–ª–∏ –≤—Å–µ 3 –∑–∞–Ω—è—Ç—ã)
        async function fillNextChild(card) {
            const cardId = card.dataset.id;
            const children = Array.from(canvas.querySelectorAll(`.card[data-parent="${cardId}"]`));
            
            // –ò—â–µ–º –ø—É—Å—Ç—ã–µ –¥–æ—á–µ—Ä–Ω–∏–µ –æ–±—ä–µ–∫—Ç—ã
            const emptyChildren = children.filter(child => !child.dataset.name || !child.dataset.uid);
            
            if (emptyChildren.length > 0) {
                // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—É—Å—Ç—ã–µ –¥–æ—á–µ—Ä–Ω–∏–µ –æ–±—ä–µ–∫—Ç—ã - –∑–∞–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–≤—ã–π –ø–æ –ø–æ—Ä—è–¥–∫—É —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–µ top (—Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑)
                emptyChildren.sort((a, b) => {
                    const topA = parseInt(a.style.top) || 0;
                    const topB = parseInt(b.style.top) || 0;
                    return topA - topB;
                });
                
                const emptyChild = emptyChildren[0];
                if (!emptyChild.dataset.name) emptyChild.dataset.name = generateRandomName();
                if (!emptyChild.dataset.uid) emptyChild.dataset.uid = generateRandomId();
                // –ù–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å —É—Ä–æ–≤–Ω–µ–º 0
                emptyChild.dataset.level = '0';
                renderCardContents(emptyChild);
                await saveCardToDatabase(emptyChild);
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å —Ä–æ–¥–∏—Ç–µ–ª—è –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞
                recalculateLevel(card);
            } else if (children.length >= 3) {
                // –ï—Å–ª–∏ –≤—Å–µ 3 –¥–æ—á–µ—Ä–Ω–∏—Ö –æ–±—ä–µ–∫—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã, –∏—â–µ–º –¥–æ—á–µ—Ä–Ω–∏–π –æ–±—ä–µ–∫—Ç —Å –Ω–∞–∏–º–µ–Ω—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –≤–Ω—É–∫–æ–≤
                const childrenWithStats = children.map(child => {
                    const grandchildren = Array.from(canvas.querySelectorAll(`.card[data-parent="${child.dataset.id}"]`));
                    const filledGrandchildren = grandchildren.filter(gc => gc.dataset.name && gc.dataset.uid);
                    return {
                        child: child,
                        filledCount: filledGrandchildren.length,
                        emptyGrandchildren: grandchildren.filter(gc => !gc.dataset.name || !gc.dataset.uid)
                    };
                });
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –≤–Ω—É–∫–æ–≤ (–º–µ–Ω—å—à–µ = –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤—ã—à–µ), –∑–∞—Ç–µ–º –ø–æ –ø–æ–∑–∏—Ü–∏–∏ —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑
                childrenWithStats.sort((a, b) => {
                    if (a.filledCount !== b.filledCount) {
                        return a.filledCount - b.filledCount; // –ú–µ–Ω—å—à–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö = –≤—ã—à–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                    }
                    // –ï—Å–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø–æ–∑–∏—Ü–∏–∏ —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑
                    const topA = parseInt(a.child.style.top) || 0;
                    const topB = parseInt(b.child.style.top) || 0;
                    return topA - topB;
                });
                
                // –ò—â–µ–º –ø–µ—Ä–≤–æ–≥–æ —Å –ø—É—Å—Ç—ã–º–∏ –≤–Ω—É–∫–∞–º–∏
                for (const stat of childrenWithStats) {
                    if (stat.emptyGrandchildren.length > 0) {
                        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤–Ω—É–∫–æ–≤ —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑
                        stat.emptyGrandchildren.sort((a, b) => {
                            const topA = parseInt(a.style.top) || 0;
                            const topB = parseInt(b.style.top) || 0;
                            return topA - topB;
                        });
                        
                        const emptyGrandchild = stat.emptyGrandchildren[0];
                        if (!emptyGrandchild.dataset.name) emptyGrandchild.dataset.name = generateRandomName();
                        if (!emptyGrandchild.dataset.uid) emptyGrandchild.dataset.uid = generateRandomId();
                        // –ù–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å —É—Ä–æ–≤–Ω–µ–º 0
                        emptyGrandchild.dataset.level = '0';
                        renderCardContents(emptyGrandchild);
                        await saveCardToDatabase(emptyGrandchild);
                        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å —Ä–æ–¥–∏—Ç–µ–ª—è (–¥–æ—á–µ—Ä–Ω–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞) –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤–Ω—É–∫–∞
                        recalculateLevel(stat.child);
                        // –¢–∞–∫–∂–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –∏—Å—Ö–æ–¥–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
                        recalculateLevel(card);
                        break;
                    }
                }
            }
            
            renderCardContents(card); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
            savePositions();
            updateStats();
        }
        
        // –ü–µ—Ä–µ—Å—á–µ—Ç —É—Ä–æ–≤–Ω—è –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ —Ç–æ–≥–æ –∂–µ —É—Ä–æ–≤–Ω—è
        function recalculateLevel(card) {
            if (!card) return;
            
            const cardId = card.dataset.id;
            const currentLevel = parseInt(card.dataset.level || '0');
            
            // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ—Ö –ø—Ä—è–º—ã—Ö –¥–æ—á–µ—Ä–Ω–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (–ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤) - —Ç–æ–ª—å–∫–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ
            const partners = Array.from(canvas.querySelectorAll(`.card[data-parent="${cardId}"]`))
                .filter(child => child.dataset.name && child.dataset.uid);
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ –ø–æ —É—Ä–æ–≤–Ω—è–º
            const partnersByLevel = {};
            partners.forEach(partner => {
                const partnerLevel = parseInt(partner.dataset.level || '0');
                if (!partnersByLevel[partnerLevel]) {
                    partnersByLevel[partnerLevel] = [];
                }
                partnersByLevel[partnerLevel].push(partner);
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ –¢–ï–ö–£–©–ï–ì–û —É—Ä–æ–≤–Ω—è –∫–∞—Ä—Ç–æ—á–∫–∏
            const partnersAtCurrentLevel = partnersByLevel[currentLevel] || [];
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å 3+ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è - –ø–æ–≤—ã—à–∞–µ–º —É—Ä–æ–≤–µ–Ω—å
            if (partnersAtCurrentLevel.length >= 3) {
                const newLevel = currentLevel + 1;
                const oldLevel = parseInt(card.dataset.level || '0');
                
                if (newLevel !== oldLevel) {
                    card.dataset.level = String(newLevel);
                    renderCardContents(card);
                    saveCardToDatabase(card);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏, —á—Ç–æ–±—ã –æ–Ω–∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–ª–∏ —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å
                    const children = Array.from(canvas.querySelectorAll(`.card[data-parent="${cardId}"]`));
                    children.forEach(child => {
                        renderCardContents(child);
                    });
                    
                    // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å —Ä–æ–¥–∏—Ç–µ–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
                    const parentId = card.dataset.parent;
                    if (parentId) {
                        const parentCard = canvas.querySelector(`.card[data-id="${parentId}"]`);
                        if (parentCard) {
                            recalculateLevel(parentCard);
                        }
                    }
                } else {
                    renderCardContents(card);
                }
            } else {
                // –ï—Å–ª–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è –º–µ–Ω–µ–µ 3 - —É—Ä–æ–≤–µ–Ω—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0
                // –ù–æ —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ–º –ª–∏ –º—ã –æ—Å—Ç–∞—Ç—å—Å—è –Ω–∞ —Ç–µ–∫—É—â–µ–º —É—Ä–æ–≤–Ω–µ –∏–ª–∏ –Ω–∏–∂–µ
                // –ò—â–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –µ—Å—Ç—å 3 –ø–∞—Ä—Ç–Ω–µ—Ä–∞
                let maxLevelWith3Partners = -1;
                for (const level in partnersByLevel) {
                    const levelNum = parseInt(level);
                    if (partnersByLevel[level].length >= 3 && levelNum > maxLevelWith3Partners) {
                        maxLevelWith3Partners = levelNum;
                    }
                }
                
                // –ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å = maxLevelWith3Partners + 1 (–∏–ª–∏ 0 –µ—Å–ª–∏ –Ω–µ—Ç —Ç–∞–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è)
                const newLevel = maxLevelWith3Partners >= 0 ? maxLevelWith3Partners + 1 : 0;
                const oldLevel = parseInt(card.dataset.level || '0');
                
                if (newLevel !== oldLevel) {
                    card.dataset.level = String(newLevel);
                    renderCardContents(card);
                    saveCardToDatabase(card);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
                    const children = Array.from(canvas.querySelectorAll(`.card[data-parent="${cardId}"]`));
                    children.forEach(child => {
                        renderCardContents(child);
                    });
                    
                    // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å —Ä–æ–¥–∏—Ç–µ–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
                    const parentId = card.dataset.parent;
                    if (parentId) {
                        const parentCard = canvas.querySelector(`.card[data-id="${parentId}"]`);
                        if (parentCard) {
                            recalculateLevel(parentCard);
                        }
                    }
                } else {
                    renderCardContents(card);
                }
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        async function saveCardToDatabase(card) {
            try {
                const parentId = card.dataset.parent;
                const parentCard = parentId ? canvas.querySelector(`.card[data-id="${parentId}"]`) : null;
                const inviterId = parentCard ? parentCard.dataset.uid : null;
                
                const cardData = {
                    uid: card.dataset.uid,
                    name: card.dataset.name,
                    level: parseInt(card.dataset.level || '0'),
                    display_level: parseInt(card.dataset.level || '0'),
                    inviter_uid: inviterId,
                    left: parseInt(card.style.left) || 0,
                    top: parseInt(card.style.top) || 0
                };
                
                const response = await fetch('/admin-panel/api/save-card/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(cardData)
                });
                
                if (!response.ok) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏:', await response.text());
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –±–∞–∑—É:', error);
            }
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞ –∏–∑ cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        function generateRandomId() { return String(Math.floor(1000000 + Math.random()*9000000)); }
        function generateRandomName() {
            const first = ['Alex','Ivan','Olga','Anna','Max','Nina','Oleg','Ilya','Vera','Mira','Dima','Pavel'];
            const last = ['Petrov','Sidorov','Morozov','Kuznetsov','Smirnov','Volkov','Lebedev','Antonov'];
            return first[Math.floor(Math.random()*first.length)] + ' ' + last[Math.floor(Math.random()*last.length)];
        }
        const canvas = document.getElementById('canvas');
        const grid = document.getElementById('grid');
        const links = document.getElementById('links');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã—Ö –ª–∏–Ω–∏–π-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤
        let guideLineDragging = null;
        function initGuideLines() {
            // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
            const guideLines = canvas.querySelectorAll('.guide-line');
            guideLines.forEach(line => {
                line.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    guideLineDragging = line;
                    const { y } = toCanvasCoords(e.clientX, e.clientY);
                    const lineTop = parseInt(line.style.top) || 0;
                    guideLineDragging.dataset.dragOffset = y - lineTop;
                    guideLineDragging.dataset.dragType = 'horizontal';
                    line.style.opacity = '1';
                });
            });
            
            // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
            const guideLinesVertical = canvas.querySelectorAll('.guide-line-vertical');
            guideLinesVertical.forEach(line => {
                line.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    guideLineDragging = line;
                    const { x } = toCanvasCoords(e.clientX, e.clientY);
                    const lineLeft = parseInt(line.style.left) || 0;
                    guideLineDragging.dataset.dragOffset = x - lineLeft;
                    guideLineDragging.dataset.dragType = 'vertical';
                    line.style.opacity = '1';
                });
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –ª–∏–Ω–∏–π
        window.addEventListener('mousemove', (e) => {
            if (!guideLineDragging) return;
            const dragType = guideLineDragging.dataset.dragType;
            
            if (dragType === 'horizontal') {
                const { y } = toCanvasCoords(e.clientX, e.clientY);
                const dragOffset = parseFloat(guideLineDragging.dataset.dragOffset || 0);
                const newTop = y - dragOffset;
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö canvas
                const clampedTop = Math.max(0, Math.min(8450, newTop));
                guideLineDragging.style.top = Math.round(clampedTop / GRID_SIZE) * GRID_SIZE + 'px';
            } else if (dragType === 'vertical') {
                const { x } = toCanvasCoords(e.clientX, e.clientY);
                const dragOffset = parseFloat(guideLineDragging.dataset.dragOffset || 0);
                const newLeft = x - dragOffset;
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö canvas
                const clampedLeft = Math.max(0, Math.min(6500, newLeft));
                guideLineDragging.style.left = Math.round(clampedLeft / GRID_SIZE) * GRID_SIZE + 'px';
            }
        });
        
        window.addEventListener('mouseup', () => {
            if (guideLineDragging) {
                guideLineDragging.style.opacity = '0.7';
                guideLineDragging = null;
            }
        });
        const btnGrid = document.getElementById('toggleGrid');
        const btnCenter = document.getElementById('center');
        const btnSnap = document.getElementById('snap');
        const btnZoomIn = document.getElementById('zoomIn');
        const btnZoomOut = document.getElementById('zoomOut');
        const btnShowAll = document.getElementById('showAll');
        const btnShowFullGrid = document.getElementById('showFullGrid');
        const btnAutoLayout = document.getElementById('autoLayout');
        const btnImportCoords = document.getElementById('importCoords');
        const btnExportCoords = document.getElementById('exportCoords');
        const btnClearTestData = document.getElementById('clearTestData');
        const btnClearAll = document.getElementById('clearAll');
        const btnSaveLayout = document.getElementById('saveLayout');
        const btnMenuToggle = document.getElementById('menuToggle');
        const menuDropdown = document.getElementById('menuDropdown');
        const statsContent = document.getElementById('statsContent');
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–Ω—é
        btnMenuToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            menuDropdown.classList.toggle('show');
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', (e) => {
            if (!menuDropdown.contains(e.target) && e.target !== btnMenuToggle) {
                menuDropdown.classList.remove('show');
            }
        });

        let scale = 1; // 0.5..2
        let offsetX = 0; // –ø–∞–Ω–æ—Ä–∞–º–∞
        let offsetY = 0;
        let isPanning = false;
        let panStartX = 0, panStartY = 0;
        let canvasStartX = 0, canvasStartY = 0;
        let snapEnabled = true;

        function clampOffsets() {
            const canvasW = 6500 * scale;
            const canvasH = 8450 * scale;
            const minX = Math.min(0, viewport.clientWidth - canvasW);
            const minY = Math.min(0, viewport.clientHeight - canvasH);
            const maxX = 0;
            const maxY = 0;
            offsetX = Math.max(minX, Math.min(maxX, offsetX));
            offsetY = Math.max(minY, Math.min(maxY, offsetY));
        }
        function applyTransform() {
            clampOffsets();
            canvas.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
        }

        // –ü–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –ø—É—Å—Ç–æ–º—É –º–µ—Å—Ç—É
        viewport.addEventListener('mousedown', (e) => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –Ω–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –∏–ª–∏ –µ—ë –¥–æ—á–µ—Ä–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–∞—Ö
            if (e.target.closest('.card')) return;
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ –∏–¥–µ—Ç drag –∫–∞—Ä—Ç–æ—á–∫–∏
            if (dragging) return;
            isPanning = true;
            panStartX = e.clientX;
            panStartY = e.clientY;
            canvasStartX = offsetX;
            canvasStartY = offsetY;
        });
        window.addEventListener('mousemove', (e) => {
            // –ï—Å–ª–∏ –∏–¥–µ—Ç drag –∫–∞—Ä—Ç–æ—á–∫–∏, –Ω–µ –ø–∞–Ω–æ—Ä–∞–º–∏—Ä—É–µ–º
            if (dragging) {
                isPanning = false;
                return;
            }
            if (!isPanning) return;
            offsetX = canvasStartX + (e.clientX - panStartX);
            offsetY = canvasStartY + (e.clientY - panStartY);
            applyTransform();
        });
        window.addEventListener('mouseup', () => { 
            isPanning = false;
        });

        // –ó—É–º –∫–æ–ª—ë—Å–∏–∫–æ–º
        viewport.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY < 0 ? 1.1 : 0.9;
            const prevScale = scale;
            scale = Math.min(2, Math.max(0.5, scale * delta));
            // –ú–∞—Å—à—Ç–∞–± –≤–æ–∫—Ä—É–≥ –∫—É—Ä—Å–æ—Ä–∞
            const rect = viewport.getBoundingClientRect();
            const cx = e.clientX - rect.left;
            const cy = e.clientY - rect.top;
            offsetX = cx - (cx - offsetX) * (scale / prevScale);
            offsetY = cy - (cy - offsetY) * (scale / prevScale);
            applyTransform();
        }, { passive: false });

        btnZoomIn.onclick = () => { scale = Math.min(2, scale * 1.1); applyTransform(); };
        btnZoomOut.onclick = () => { scale = Math.max(0.5, scale * 0.9); applyTransform(); };
        btnCenter.onclick = () => {
            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª–æ—Ç–Ω–æ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ –∏ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
            offsetX = (viewport.clientWidth - 6500 * scale) / 2;
            offsetY = (viewport.clientHeight - 8450 * scale) / 2;
            applyTransform();
        };
        btnSaveLayout.onclick = () => {
            savePositions();
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
            const btn = btnSaveLayout;
            const originalText = btn.textContent;
            btn.textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!';
            btn.style.background = '#22c55e';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#10b981';
            }, 2000);
        };
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
        function showAllCards() {
            const cards = Array.from(canvas.querySelectorAll('.card'));
            if (cards.length === 0) return;
            
            // –ù–∞—Ö–æ–¥–∏–º –≥—Ä–∞–Ω–∏—Ü—ã –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
            let minX = Infinity, maxX = -Infinity;
            let minY = Infinity, maxY = -Infinity;
            
            cards.forEach(card => {
                const left = parseInt(card.style.left) || 0;
                const top = parseInt(card.style.top) || 0;
                const width = card.offsetWidth || 160;
                const height = card.offsetHeight || 80;
                
                minX = Math.min(minX, left);
                maxX = Math.max(maxX, left + width);
                minY = Math.min(minY, top);
                maxY = Math.max(maxY, top + height);
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø—ã
            const padding = 100;
            const cardsWidth = maxX - minX + padding * 2;
            const cardsHeight = maxY - minY + padding * 2;
            const centerX = (minX + maxX) / 2;
            const centerY = (minY + maxY) / 2;
            
            // –í—ã—á–∏—Å–ª—è–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–±
            const scaleX = viewport.clientWidth / cardsWidth;
            const scaleY = viewport.clientHeight / cardsHeight;
            scale = Math.min(2, Math.max(0.3, Math.min(scaleX, scaleY) * 0.9)); // 90% —á—Ç–æ–±—ã –±—ã–ª –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø
            
            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
            offsetX = (viewport.clientWidth - 6500 * scale) / 2 + (3250 - centerX) * scale;
            offsetY = (viewport.clientHeight - 8450 * scale) / 2 + (4225 - centerY) * scale;
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
            clampOffsets();
            applyTransform();
        }
        
        btnShowAll.onclick = () => showAllCards();
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—é —Å–µ—Ç–∫—É (–≤–µ—Å—å canvas —Ü–µ–ª–∏–∫–æ–º)
        function showFullGrid() {
            const CANVAS_WIDTH = 6500;
            const CANVAS_HEIGHT = 8450;
            
            // –í—ã—á–∏—Å–ª—è–µ–º –º–∞—Å—à—Ç–∞–±, —á—Ç–æ–±—ã –≤–µ—Å—å canvas –ø–æ–º–µ—Å—Ç–∏–ª—Å—è –≤ viewport
            const scaleX = viewport.clientWidth / CANVAS_WIDTH;
            const scaleY = viewport.clientHeight / CANVAS_HEIGHT;
            scale = Math.min(2, Math.max(0.1, Math.min(scaleX, scaleY) * 0.95)); // 95% —á—Ç–æ–±—ã –±—ã–ª –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø
            
            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º canvas
            offsetX = (viewport.clientWidth - CANVAS_WIDTH * scale) / 2;
            offsetY = (viewport.clientHeight - CANVAS_HEIGHT * scale) / 2;
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
            clampOffsets();
            applyTransform();
        }
        
        btnShowFullGrid.onclick = () => showFullGrid();
        
        // –ò–º–ø–æ—Ä—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∏–∑ —Ñ–∞–π–ª–∞
        function importCoordinatesFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importData = JSON.parse(event.target.result);
                        
                        if (!importData.cards || !Array.isArray(importData.cards)) {
                            alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –û–∂–∏–¥–∞–µ—Ç—Å—è –º–∞—Å—Å–∏–≤ cards.');
                            return;
                        }
                        
                        // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (–∫—Ä–æ–º–µ root, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å)
                        const rootCard = canvas.querySelector('.card[data-id="root"]');
                        canvas.querySelectorAll('.card').forEach(card => {
                            if (card !== rootCard) card.remove();
                        });
                        
                        // –û—á–∏—â–∞–µ–º childMap
                        childMap.clear();
                        
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º uidCounter
                        if (importData.uidCounter) {
                            uidCounter = importData.uidCounter;
                        }
                        
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
                        const cardMap = new Map();
                        if (rootCard) {
                            cardMap.set('root', rootCard);
                        }
                        
                        importData.cards.forEach(item => {
                            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º root, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –µ—Å—Ç—å
                            if (item.id === 'root' && rootCard) {
                                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é root, –µ—Å–ª–∏ –æ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
                                if (item.left !== undefined) rootCard.style.left = item.left + 'px';
                                if (item.top !== undefined) rootCard.style.top = item.top + 'px';
                                return;
                            }
                            
                            let card = canvas.querySelector(`.card[data-id="${item.id}"]`);
                            if (!card) {
                                card = document.createElement('div');
                                card.className = 'card';
                                card.dataset.id = item.id;
                                canvas.appendChild(card);
                            }
                            
                            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∞—Ç—Ä–∏–±—É—Ç—ã
                            if (item.parent) card.dataset.parent = item.parent;
                            if (typeof item.level === 'number') card.dataset.level = String(item.level);
                            if (item.name) card.dataset.name = item.name;
                            if (item.uid) card.dataset.uid = item.uid;
                            if (item.left !== undefined) card.style.left = item.left + 'px';
                            if (item.top !== undefined) card.style.top = item.top + 'px';
                            
                            // –†–µ–Ω–¥–µ—Ä–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                            renderCardContents(card);
                            // –í–∫–ª—é—á–∞–µ–º drag –∏ —Ç–æ—á–∫–∏
                            enableDrag(card);
                            cardMap.set(item.id, card);
                        });
                        
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º childMap –∏–∑ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                        if (importData.childMap) {
                            importData.childMap.forEach(([parent, children]) => {
                                childMap.set(parent, new Set(children));
                            });
                        } else {
                            // –ï—Å–ª–∏ childMap –Ω–µ—Ç –≤ —Ñ–∞–π–ª–µ, —Å—Ç—Ä–æ–∏–º –µ–≥–æ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
                            importData.cards.forEach(item => {
                                if (item.parent) {
                                    if (!childMap.has(item.parent)) {
                                        childMap.set(item.parent, new Set());
                                    }
                                    childMap.get(item.parent).add(item.id);
                                }
                            });
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ—á–µ–∫
                        cardMap.forEach(card => {
                            updatePointsState(card);
                        });
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤—è–∑–∏
                        updateAllConnections();
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ localStorage
                        savePositions();
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                        updateStats();
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                        const btn = btnImportCoords;
                        const originalText = btn.textContent;
                        btn.textContent = '‚úì –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ!';
                        btn.style.background = '#22c55e';
                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.style.background = '#06b6d4';
                        }, 2000);
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞
                        setTimeout(() => showAllCards(), 300);
                        
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:', error);
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Ñ–∞–π–ª–∞: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        btnImportCoords.onclick = () => importCoordinatesFromFile();
        
        // –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ —Ñ–∞–π–ª
        function exportCoordinatesToFile() {
            const cards = Array.from(canvas.querySelectorAll('.card'));
            const cardsData = cards.map(card => {
                const level = parseInt(card.dataset.level || '0');
                const displayLevel = level;
                return {
                    id: card.dataset.id,
                    name: card.dataset.name || '',
                    uid: card.dataset.uid || '',
                    level: level,
                    displayLevel: displayLevel,
                    parent: card.dataset.parent || null,
                    left: parseInt(card.style.left) || 0,
                    top: parseInt(card.style.top) || 0,
                    width: card.offsetWidth || 160,
                    height: card.offsetHeight || 80
                };
            });
            
            const exportData = {
                timestamp: new Date().toISOString(),
                canvasWidth: 6500,
                canvasHeight: 8450,
                totalCards: cardsData.length,
                uidCounter: uidCounter,
                childMap: Array.from(childMap.entries()).map(([parent, children]) => [parent, Array.from(children)]),
                cards: cardsData.sort((a, b) => {
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É—Ä–æ–≤–Ω—é, –∑–∞—Ç–µ–º –ø–æ –ø–æ–∑–∏—Ü–∏–∏
                    if (a.displayLevel !== b.displayLevel) return b.displayLevel - a.displayLevel;
                    if (a.top !== b.top) return a.top - b.top;
                    return a.left - b.left;
                })
            };
            
            // –°–æ–∑–¥–∞–µ–º JSON —Ñ–∞–π–ª –∏ —Å–∫–∞—á–∏–≤–∞–µ–º
            const jsonStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `structure_coordinates_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const btn = btnExportCoords;
            const originalText = btn.textContent;
            btn.textContent = '‚úì –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ!';
            btn.style.background = '#22c55e';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#8b5cf6';
            }, 2000);
        }
        
        btnExportCoords.onclick = () => exportCoordinatesToFile();

        // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–µ—Ç–∫–∏
        let gridVisible = true;
        btnGrid.onclick = () => {
            gridVisible = !gridVisible;
            grid.style.display = gridVisible ? 'block' : 'none';
            btnGrid.textContent = gridVisible ? '–°–∫—Ä—ã—Ç—å —Å–µ—Ç–∫—É' : '–ü–æ–∫–∞–∑–∞—Ç—å —Å–µ—Ç–∫—É';
        };
        btnSnap.onclick = () => {
            snapEnabled = !snapEnabled;
            btnSnap.textContent = `–ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Ç–∫–µ: ${snapEnabled ? '–í–∫–ª' : '–í—ã–∫–ª'}`;
        };

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ: –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä id –∏ —Ä–∞–±–æ—Ç–∞ —Å –¥–µ—Ç—å–º–∏
        const childMap = new Map(); // parentId -> Set(childIds)
        let uidCounter = 1;
        function genId() { return 'node-' + (uidCounter++); }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π
        const STORAGE_KEY = 'structure_v2_positions';
        const LAYOUT_TEMPLATE_KEY = 'structure_v2_layout_template';
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —à–∞–±–ª–æ–Ω —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è –¥–µ—Ç–µ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è
        function saveLayoutTemplate() {
            const templates = {};
            canvas.querySelectorAll('.card').forEach(parentCard => {
                const parentId = parentCard.dataset.id;
                const children = Array.from(canvas.querySelectorAll(`.card[data-parent="${parentId}"]`));
                if (children.length === 0) return;
                
                const px = parseInt(parentCard.style.left) || 0;
                const py = parseInt(parentCard.style.top) || 0;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–µ—Ç–µ–π
                const childPositions = children.map(child => {
                    const cx = parseInt(child.style.left) || 0;
                    const cy = parseInt(child.style.top) || 0;
                    return {
                        offsetX: cx - px,
                        offsetY: cy - py
                    };
                });
                
                templates[parentId] = childPositions;
            });
            localStorage.setItem(LAYOUT_TEMPLATE_KEY, JSON.stringify(templates));
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —à–∞–±–ª–æ–Ω —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª—è
        function loadLayoutTemplate(parentId) {
            const saved = localStorage.getItem(LAYOUT_TEMPLATE_KEY);
            if (!saved) return null;
            try {
                const templates = JSON.parse(saved);
                return templates[parentId] || null;
            } catch (e) {
                return null;
            }
        }
        
        function savePositions() {
            const cards = Array.from(canvas.querySelectorAll('.card'));
            const data = {
                uidCounter,
                cards: cards.map(card => ({
                    id: card.dataset.id,
                    parent: card.dataset.parent || null,
                    left: parseInt(card.style.left) || 0,
                    top: parseInt(card.style.top) || 0,
                    level: parseInt(card.dataset.level || '0'),
                    name: card.dataset.name || '',
                    uid: card.dataset.uid || ''
                })),
                childMap: Array.from(childMap.entries()).map(([parent, children]) => [parent, Array.from(children)])
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —à–∞–±–ª–æ–Ω —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è
            saveLayoutTemplate();
        }
        function loadPositions() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return false;
            try {
                const data = JSON.parse(saved);
                uidCounter = data.uidCounter || 1;
                // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
                canvas.querySelectorAll('.card').forEach(card => card.remove());
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º childMap
                childMap.clear();
                if (data.childMap) {
                    data.childMap.forEach(([parent, children]) => {
                        childMap.set(parent, new Set(children));
                    });
                }
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
                const cardMap = new Map();
                data.cards.forEach(item => {
                    let card = canvas.querySelector(`.card[data-id="${item.id}"]`);
                    if (!card) {
                        card = document.createElement('div');
                        card.className = 'card';
                        card.dataset.id = item.id;
                        canvas.appendChild(card);
                    }
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∞—Ç—Ä–∏–±—É—Ç—ã
                    if (item.parent) card.dataset.parent = item.parent;
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –Ω–∞ 0 –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –∫—Ä–æ–º–µ root
                    if (item.id === 'root') {
                        card.dataset.level = '0'; // Root –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ 0
                    } else {
                        card.dataset.level = '0'; // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–µ–Ω—å 0
                    }
                    if (item.name) card.dataset.name = item.name;
                    if (item.uid) card.dataset.uid = item.uid;
                    card.style.left = item.left + 'px';
                    card.style.top = item.top + 'px';
                    // –†–µ–Ω–¥–µ—Ä–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                    renderCardContents(card);
                    // –í–∫–ª—é—á–∞–µ–º drag –∏ —Ç–æ—á–∫–∏
                    enableDrag(card);
                    cardMap.set(item.id, card);
                });
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ—á–µ–∫
                cardMap.forEach(card => {
                    updatePointsState(card);
                });
                updateAllConnections();
                
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —É—Ä–æ–≤–Ω–∏ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ (—Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö)
                // –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —É—Ä–æ–≤–Ω–∏ –Ω–∞ 0 (–∫—Ä–æ–º–µ root)
                cardMap.forEach(card => {
                    if (card.dataset.id !== 'root') {
                        card.dataset.level = '0';
                    }
                });
                
                // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –ª–∏—Å—Ç—å—è (–∫–∞—Ä—Ç–æ—á–∫–∏ –±–µ–∑ –¥–µ—Ç–µ–π) –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Ç –Ω–∏—Ö –≤–≤–µ—Ä—Ö
                function getAllDescendants(cardId) {
                    return Array.from(canvas.querySelectorAll(`.card[data-parent="${cardId}"]`));
                }
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ –≥–ª—É–±–∏–Ω–µ –≤ –¥–µ—Ä–µ–≤–µ (–æ—Ç –ª–∏—Å—Ç—å–µ–≤ –∫ –∫–æ—Ä–Ω—é)
                const sortedCards = Array.from(cardMap.values()).sort((a, b) => {
                    // –í—ã—á–∏—Å–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≥–ª—É–±–∏–Ω—É –ø–æ–¥–¥–µ—Ä–µ–≤–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
                    function getMaxDepth(cardId) {
                        const children = getAllDescendants(cardId);
                        if (children.length === 0) return 0;
                        return 1 + Math.max(...children.map(child => getMaxDepth(child.dataset.id)));
                    }
                    const depthA = getMaxDepth(a.dataset.id);
                    const depthB = getMaxDepth(b.dataset.id);
                    return depthB - depthA; // –û—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É (–æ—Ç –ª–∏—Å—Ç—å–µ–≤ –∫ –∫–æ—Ä–Ω—é)
                });
                
                sortedCards.forEach(card => {
                    if (card.dataset.id !== 'root') {
                        recalculateLevel(card);
                    }
                });
                
                updateStats();
                return true;
            } catch (e) {
                console.error('Failed to load positions:', e);
                return false;
            }
        }
        function getChildSet(parentId) {
            if (!childMap.has(parentId)) childMap.set(parentId, new Set());
            return childMap.get(parentId);
        }
        function updatePointsState(card) {
            const pid = card.dataset.id;
            const count = (getChildSet(pid)).size;
            const disabled = count >= 3;
            card.querySelectorAll('.point').forEach(p => p.classList.toggle('disabled', disabled));
        }
        function attachPoints(card) {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ç–æ—á–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
            card.querySelectorAll('.point').forEach(p => p.remove());
            const left = document.createElement('div'); left.className = 'point left'; left.title = '–î–æ–±–∞–≤–∏—Ç—å —Å–ª–µ–≤–∞';
            const right = document.createElement('div'); right.className = 'point right'; right.title = '–î–æ–±–∞–≤–∏—Ç—å —Å–ø—Ä–∞–≤–∞';
            left.addEventListener('click', (e) => { e.stopPropagation(); createChild(card, 'left'); });
            right.addEventListener('click', (e) => { e.stopPropagation(); createChild(card, 'right'); });
            card.appendChild(left); card.appendChild(right);
            updatePointsState(card);
        }

        function createChild(parentCard, side) {
            const parentId = parentCard.dataset.id;
            const children = getChildSet(parentId);
            if (children.size >= 3) return; // –ª–∏–º–∏—Ç

            const id = genId();
            const child = document.createElement('div');
            child.className = 'card';
            child.dataset.id = id;
            child.dataset.parent = parentId;
            child.dataset.level = '0'; // –ù–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å —É—Ä–æ–≤–Ω–µ–º 0
            // –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–º—è –∏ ID - –∫–∞—Ä—Ç–æ—á–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—É—Å—Ç–æ–π
            const px = parseInt(parentCard.style.left) || 0;
            const py = parseInt(parentCard.style.top) || 0;
            const index = children.size; // 0..2
            
            // –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è
            const template = loadLayoutTemplate(parentId);
            let nx, ny;
            
            if (template && template.length > index) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω
                const templatePos = template[index];
                nx = px + templatePos.offsetX;
                ny = py + templatePos.offsetY;
            } else {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ª–æ–≥–∏–∫—É
                const horizontalOffset = side === 'left' ? -240 : 240;
                // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ —É—Ä–æ–≤–Ω–∏: –ø–µ—Ä–≤—ã–π –≤—ã—à–µ, –≤—Ç–æ—Ä–æ–π –ø–æ —Ü–µ–Ω—Ç—Ä—É, —Ç—Ä–µ—Ç–∏–π –Ω–∏–∂–µ
                // –ë–µ—Ä—ë–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ä–µ–±—ë–Ω–∫–∞, –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –¥–µ—Ñ–æ–ª—Ç 120
                let dy = 120;
                const existing = Array.from(canvas.querySelectorAll(`.card[data-parent="${parentId}"]`));
                if (existing.length > 0) {
                    const base = py + 200;
                    // –ë–µ—Ä—ë–º —Å–º–µ—â–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–±—ë–Ω–∫–∞ (–ø–æ –º–æ–¥—É–ª—é)
                    const firstChild = existing[0];
                    const firstOffset = Math.abs((parseInt(firstChild.style.top) || 0) - base);
                    if (firstOffset > 0) dy = Math.max(40, Math.min(240, firstOffset));
                }
                const verticalLevels = [-dy, 0, dy]; // –≤—ã—à–µ, —Ü–µ–Ω—Ç—Ä, –Ω–∏–∂–µ
                const baseY = py + 200;
                const vy = verticalLevels[Math.min(index, 2)];
                nx = px + horizontalOffset + (side === 'left' ? -index * 0 : 0);
                ny = baseY + vy;
            }
            
            // –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Ç–∫–µ
            const snappedX = Math.round(nx / GRID_SIZE) * GRID_SIZE;
            const snappedY = Math.round(ny / GRID_SIZE) * GRID_SIZE;
            child.style.left = snappedX + 'px';
            child.style.top = snappedY + 'px';
            renderCardContents(child);
            canvas.appendChild(child);
            attachPoints(child);
            enableDrag(child);
            children.add(id);
            updatePointsState(parentCard);
            updateConnectionFor(child);
            savePositions();
            updateStats();
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ –≤—Å–µ—Ö –µ—ë –¥–æ—á–µ—Ä–Ω–∏—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ (—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ)
        function deleteCardAndChildren(card) {
            if (!card || card.dataset.id === 'root') return; // –ù–µ —É–¥–∞–ª—è–µ–º root
            
            const cardId = card.dataset.id;
            
            // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ—Ö –¥–µ—Ç–µ–π —ç—Ç–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
            const children = Array.from(canvas.querySelectorAll(`.card[data-parent="${cardId}"]`));
            
            // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —É–¥–∞–ª—è–µ–º –≤—Å–µ—Ö –¥–µ—Ç–µ–π
            children.forEach(child => {
                deleteCardAndChildren(child);
            });
            
            // –£–¥–∞–ª—è–µ–º —Å–≤—è–∑–∏ (SVG –ø—É—Ç–∏)
            const linkGroup = document.getElementById('link-' + cardId);
            if (linkGroup) linkGroup.remove();
            
            // –£–¥–∞–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∏–∑ childMap —Ä–æ–¥–∏—Ç–µ–ª—è
            const parentId = card.dataset.parent;
            if (parentId && childMap.has(parentId)) {
                childMap.get(parentId).delete(cardId);
            }
            
            // –£–¥–∞–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∏–∑ DOM
            card.remove();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ—á–µ–∫ —Ä–æ–¥–∏—Ç–µ–ª—è
            if (parentId) {
                const parentCard = canvas.querySelector(`.card[data-id="${parentId}"]`);
                if (parentCard) {
                    updatePointsState(parentCard);
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤—è–∑–∏ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
            updateAllConnections();
            savePositions();
            updateStats();
        }

        // Drag –∫–∞—Ä—Ç–æ—á–µ–∫
        let dragging = null;
        let dragOffsetX = 0, dragOffsetY = 0;
        let startLeft = 0, startTop = 0;

        function toCanvasCoords(clientX, clientY) {
            const rect = viewport.getBoundingClientRect();
            const x = (clientX - rect.left - offsetX) / scale;
            const y = (clientY - rect.top - offsetY) / scale;
            return { x, y };
        }

        function enableDrag(card) {
            attachPoints(card);
            card.addEventListener('mousedown', (e) => {
                if ((e.target).classList && (e.target).classList.contains('point')) return;
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ drag –∫–∞—Ä—Ç–æ—á–∫–∏
                isPanning = false;
                dragging = card;
                dragging.classList.add('dragging');
                const { x, y } = toCanvasCoords(e.clientX, e.clientY);
                startLeft = parseInt(card.style.left) || 0;
                startTop = parseInt(card.style.top) || 0;
                dragOffsetX = x - startLeft;
                dragOffsetY = y - startTop;
                e.preventDefault();
                e.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
            });
        }

        window.addEventListener('mousemove', (e) => {
            if (!dragging) return;
            const { x, y } = toCanvasCoords(e.clientX, e.clientY);
            const nx = x - dragOffsetX;
            const ny = y - dragOffsetY;
            dragging.style.left = nx + 'px';
            dragging.style.top = ny + 'px';
            updateConnectionsForCardAndRelatives(dragging);
        });
        window.addEventListener('mouseup', () => {
            if (!dragging) return;
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ
            isPanning = false;
            if (snapEnabled) {
                const nx = Math.round((parseInt(dragging.style.left) || 0) / GRID_SIZE) * GRID_SIZE;
                const ny = Math.round((parseInt(dragging.style.top) || 0) / GRID_SIZE) * GRID_SIZE;
                dragging.style.left = nx + 'px';
                dragging.style.top = ny + 'px';
            }
            dragging.classList.remove('dragging');
            const finished = dragging;
            dragging = null;
            if (finished) {
                updateConnectionsForCardAndRelatives(finished);
                savePositions(); // –≠—Ç–æ —Ç–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç —à–∞–±–ª–æ–Ω —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è
                updateStats();
            }
        });

        // –°–æ–∑–¥–∞–Ω–∏–µ root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        async function ensureRootInDatabase() {
            const rootCard = canvas.querySelector('.card[data-id="root"]');
            if (!rootCard) return;
            
            if (!rootCard.dataset.name) rootCard.dataset.name = 'IVA';
            if (!rootCard.dataset.uid) rootCard.dataset.uid = '0000001';
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º root –≤ –±–∞–∑—É –µ—Å–ª–∏ –µ–≥–æ —Ç–∞–º –Ω–µ—Ç
            try {
                await saveCardToDatabase(rootCard);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è root –≤ –±–∞–∑—É:', error);
            }
        }
        
        // –°—Ç–∞—Ä—Ç: –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
        if (!loadPositions()) {
            // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, —É–¥–∞–ª—è–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫—Ä–æ–º–µ root
            canvas.querySelectorAll('.card').forEach(card => {
                if (card.dataset.id !== 'root') {
                    card.remove();
                }
            });
            // –û—á–∏—â–∞–µ–º childMap
            childMap.clear();
            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º root –∫–∞—Ä—Ç–æ—á–∫—É
            const root = canvas.querySelector('.card[data-id="root"]');
            if (root) {
                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —É root –µ—Å—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã
                if (!root.dataset.level) root.dataset.level = '0';
                if (!root.dataset.name) root.dataset.name = 'IVA';
                if (!root.dataset.uid) root.dataset.uid = '0000001';
                renderCardContents(root);
                enableDrag(root);
            }
        }
        
        // –°–æ–∑–¥–∞–µ–º root –≤ –±–∞–∑–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        ensureRootInDatabase();
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω—ã
        canvas.querySelectorAll('.card').forEach(card => {
            if (!card.querySelector('.badge')) {
                renderCardContents(card);
            }
        });
        btnCenter.click();
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        updateStats();
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–µ –ª–∏–Ω–∏–∏-–æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã
        initGuideLines();

        // ----- –°–≤—è–∑–∏ (–∫–∞–∫ –≤ Miro): –≥–∏–±–∫–∏–µ –∫—Ä–∏–≤—ã–µ, —Å–ª–µ–¥—É—é—Ç –∑–∞ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ -----
        function getAnchorRight(card) {
            const left = parseInt(card.style.left) || 0;
            const top = parseInt(card.style.top) || 0;
            const w = Math.max(card.offsetWidth, 140);
            const h = Math.max(card.offsetHeight, 64);
            return { x: left + w, y: top + h / 2 };
        }
        function getAnchorLeft(card) {
            const left = parseInt(card.style.left) || 0;
            const top = parseInt(card.style.top) || 0;
            return { x: left, y: top + (Math.max(card.offsetHeight, 64) / 2) };
        }
        function pathCubic(start, end) {
            const dx = Math.max(40, Math.abs(end.x - start.x) * 0.5);
            const c1 = { x: start.x + dx, y: start.y };
            const c2 = { x: end.x - dx, y: end.y };
            return `M ${start.x} ${start.y} C ${c1.x} ${c1.y}, ${c2.x} ${c2.y}, ${end.x} ${end.y}`;
        }
        function ensureLinkPath(id) {
            let g = document.getElementById('link-' + id);
            if (!g) {
                g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('id', 'link-' + id);
                const shadow = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                shadow.setAttribute('class', 'link-shadow');
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('class', 'link-path');
                g.appendChild(shadow);
                g.appendChild(path);
                links.appendChild(g);
            }
            return g;
        }
        function updateConnectionFor(childCard) {
            const parentId = childCard.dataset.parent;
            if (!parentId) return;
            const parentCard = canvas.querySelector(`.card[data-id="${parentId}"]`);
            if (!parentCard) return;
            const start = getAnchorRight(parentCard);
            const end = getAnchorLeft(childCard);
            const d = pathCubic(start, end);
            const g = ensureLinkPath(childCard.dataset.id);
            g.firstChild.setAttribute('d', d);
            g.lastChild.setAttribute('d', d);
        }
        function updateConnectionsForCardAndRelatives(card) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤—è–∑—å –∫ —Ä–æ–¥–∏—Ç–µ–ª—é
            updateConnectionFor(card);
            // –ò —Å–≤—è–∑–∏ –∫–æ –≤—Å–µ–º –¥–µ—Ç—è–º
            const id = card.dataset.id;
            canvas.querySelectorAll(`.card[data-parent="${id}"]`).forEach(updateConnectionFor);
        }
        function updateAllConnections() {
            canvas.querySelectorAll('.card[data-parent]').forEach(updateConnectionFor);
        }
        // –Ω–∞—á–∞–ª—å–Ω–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ (–¥–ª—è root –¥–µ—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç)
        updateAllConnections();

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ –±–µ–∑ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π
        function autoLayoutCards() {
            const cards = Array.from(canvas.querySelectorAll('.card'));
            if (cards.length === 0) return;
            
            const CARD_WIDTH = 160;
            const CARD_HEIGHT = 80;
            const HORIZONTAL_GAP = 250; // –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ –Ω–∞ –æ–¥–Ω–æ–º —É—Ä–æ–≤–Ω–µ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
            const SAFETY_MARGIN = 100; // –û—Ç—Å—Ç—É–ø –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π
            const CANVAS_WIDTH = 6500; // –®–∏—Ä–∏–Ω–∞ canvas
            const CANVAS_HEIGHT = 8450; // –í—ã—Å–æ—Ç–∞ canvas
            const GRID_SIZE = 40;
            
            // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–≤–Ω—è (–ª–æ–≥–∏—á–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ)
            const centerY = CANVAS_HEIGHT / 2 + 800; // –¶–µ–Ω—Ç—Ä –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ + —Å–º–µ—â–µ–Ω–∏–µ –≤–Ω–∏–∑
            const levelConfig = {
                5: { 
                    x: 300, 
                    y: centerY, 
                    verticalGap: null 
                }, // Root: —Å–ª–µ–≤–∞, –ø–æ —Ü–µ–Ω—Ç—Ä—É –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ
                4: { 
                    x: 1200, 
                    y: null, 
                    verticalGap: 500 
                }, // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –æ—Ç—Å—Ç—É–ø –¥–ª—è –ª–∏–Ω–∏–π
                3: { 
                    x: 2200, 
                    y: null, 
                    verticalGap: 450 
                }, // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –æ—Ç—Å—Ç—É–ø
                2: { 
                    x: 3400, 
                    y: null, 
                    verticalGap: 350 
                }, // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –æ—Ç—Å—Ç—É–ø
                1: { 
                    x: 4600, 
                    y: null, 
                    verticalGap: 250 
                }, // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –æ—Ç—Å—Ç—É–ø
                0: { 
                    x: 5800, 
                    y: null, 
                    verticalGap: null 
                } // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å–ø—Ä–∞–≤–∞, —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –ø–æ –≤—ã—Å–æ—Ç–µ
            };
            
            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ ID
            const cardMap = new Map();
            cards.forEach(card => {
                cardMap.set(card.dataset.id, card);
            });
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ —É—Ä–æ–≤–Ω—è–º
            const cardsByLevel = {};
            cards.forEach(card => {
                const depth = parseInt(card.dataset.level || '0');
                const displayLevel = depth;
                if (!cardsByLevel[displayLevel]) cardsByLevel[displayLevel] = [];
                cardsByLevel[displayLevel].push(card);
            });
            
            // –•—Ä–∞–Ω–∏–º –≤—Å–µ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π
            const allPlacedRects = [];
            
            // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ —Å —É–∂–µ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–º–∏
            function hasCollision(rect, excludeCard = null) {
                for (const placed of allPlacedRects) {
                    if (excludeCard && placed.card === excludeCard) continue;
                    if (!(rect.right + SAFETY_MARGIN < placed.left || 
                          rect.left - SAFETY_MARGIN > placed.right ||
                          rect.bottom + SAFETY_MARGIN < placed.top || 
                          rect.top - SAFETY_MARGIN > placed.bottom)) {
                        return true;
                    }
                }
                return false;
            }
            
            // –†–∞–∑–º–µ—â–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ —É—Ä–æ–≤–Ω—è–º
            [5, 4, 3, 2, 1, 0].forEach(displayLevel => {
                const levelCards = cardsByLevel[displayLevel] || [];
                if (levelCards.length === 0) return;
                
                const config = levelConfig[displayLevel];
                const levelX = config.x;
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ –ø–æ–∑–∏—Ü–∏–∏ —Ä–æ–¥–∏—Ç–µ–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
                levelCards.sort((a, b) => {
                    const aParentId = a.dataset.parent || 'root';
                    const bParentId = b.dataset.parent || 'root';
                    const aParent = cardMap.get(aParentId);
                    const bParent = cardMap.get(bParentId);
                    
                    if (aParent && bParent) {
                        const aX = parseInt(aParent.style.left) || 0;
                        const bX = parseInt(bParent.style.left) || 0;
                        if (aX !== bX) return aX - bX;
                    }
                    return (a.dataset.id || '').localeCompare(b.dataset.id || '');
                });
                
                // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ Y –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
                let cardYPositions = [];
                
                if (displayLevel === 5) {
                    // –£—Ä–æ–≤–µ–Ω—å 5: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è Y
                    cardYPositions = levelCards.map(() => config.y);
                } else if (displayLevel === 0) {
                    // –£—Ä–æ–≤–µ–Ω—å 0: —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –ø–æ –≤—Å–µ–π –≤—ã—Å–æ—Ç–µ —Å —Å–º–µ—â–µ–Ω–∏–µ–º –≤–Ω–∏–∑
                    const topMargin = 600;
                    const bottomMargin = 600;
                    const availableHeight = CANVAS_HEIGHT - topMargin - bottomMargin;
                    const spacing = levelCards.length > 1 
                        ? availableHeight / (levelCards.length - 1) 
                        : 0;
                    cardYPositions = levelCards.map((_, index) => topMargin + index * spacing);
                } else {
                    // –£—Ä–æ–≤–Ω–∏ 4, 3, 2, 1: —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ–º –º–µ–∂–¥—É –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏
                    const totalHeight = (levelCards.length - 1) * config.verticalGap;
                    const startY = (CANVAS_HEIGHT - totalHeight) / 2 + 600; // –°–º–µ—â–µ–Ω–∏–µ –≤–Ω–∏–∑
                    cardYPositions = levelCards.map((_, index) => startY + index * config.verticalGap);
                }
                
                // –í—ã—á–∏—Å–ª—è–µ–º —à–∏—Ä–∏–Ω—É –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞ —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ
                const totalCardsWidth = levelCards.length * CARD_WIDTH + (levelCards.length - 1) * HORIZONTAL_GAP;
                
                // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –≥—Ä—É–ø–ø—É –∫–∞—Ä—Ç–æ—á–µ–∫ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ levelX
                let currentX = levelX - totalCardsWidth / 2;
                
                // –†–∞–∑–º–µ—â–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
                levelCards.forEach((child, index) => {
                    const y = cardYPositions[index];
                    let cardX = currentX;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –∏ —Å–¥–≤–∏–≥–∞–µ–º –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
                    let attempts = 0;
                    let hasOverlap = true;
                    while (hasOverlap && attempts < 300) {
                        const testRect = {
                            left: cardX,
                            right: cardX + CARD_WIDTH,
                            top: y,
                            bottom: y + CARD_HEIGHT
                        };
                        
                        if (hasCollision(testRect)) {
                            cardX += HORIZONTAL_GAP / 3;
                            attempts++;
                        } else {
                            hasOverlap = false;
                        }
                    }
                    
                    const x = Math.round(cardX / GRID_SIZE) * GRID_SIZE;
                    child.style.left = x + 'px';
                    child.style.top = Math.round(y / GRID_SIZE) * GRID_SIZE + 'px';
                    
                    allPlacedRects.push({
                        card: child,
                        left: x,
                        right: x + CARD_WIDTH,
                        top: y,
                        bottom: y + CARD_HEIGHT
                    });
                    
                    currentX = x + CARD_WIDTH + HORIZONTAL_GAP;
                });
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤—è–∑–∏ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
            updateAllConnections();
            savePositions();
            updateStats();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º canvas –ø–æ—Å–ª–µ —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏
            setTimeout(() => {
                btnCenter.click();
            }, 100);
        }
        
        btnAutoLayout.onclick = () => autoLayoutCards();

        // –ü–æ–¥—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —É—Ä–æ–≤–Ω—è–º - —Å—á–∏—Ç–∞–µ–º –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ –ø–µ—Ä–≤–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ (root)
        function updateStats() {
            const cards = Array.from(canvas.querySelectorAll('.card'));
            const rootCard = cards.find(card => card.dataset.id === 'root');
            
            if (!rootCard) {
                statsContent.innerHTML = '<div class="stats-item">–ù–µ—Ç root –∫–∞—Ä—Ç–æ—á–∫–∏</div>';
                return;
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä—è–º—ã—Ö –¥–µ—Ç–µ–π –∫–∞—Ä—Ç–æ—á–∫–∏
            function getDirectChildren(parentId) {
                return Array.from(canvas.querySelectorAll(`.card[data-parent="${parentId}"]`));
            }
            
            // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–≤–Ω—è —Å—á–∏—Ç–∞–µ–º –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ root (—Ç–æ–ª—å–∫–æ –ø—Ä—è–º—ã–µ –¥–µ—Ç–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è)
            const levelStats = {};
            const cardsByLevel = {}; // –ö—ç—à –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ —É—Ä–æ–≤–Ω—è–º
            
            // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
            let maxLevel = 0;
            cards.forEach(card => {
                const level = parseInt(card.dataset.level || '0');
                if (level > maxLevel) maxLevel = level;
                if (!cardsByLevel[level]) cardsByLevel[level] = [];
                cardsByLevel[level].push(card);
            });
            
            // –ù–∞—á–∏–Ω–∞–µ–º —Å —É—Ä–æ–≤–Ω—è root
            const rootLevel = parseInt(rootCard.dataset.level || '0');
            
            // –î–ª—è root —Å—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –≤—Å–µ–º —É—Ä–æ–≤–Ω—è–º –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
            // –õ–æ–≥–∏–∫–∞: –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–≤–Ω—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ —Å—á–∏—Ç–∞–µ–º –∏—Ö –ø—Ä—è–º—ã—Ö –¥–µ—Ç–µ–π —É—Ä–æ–≤–Ω—è (level - 1)
            // –ù–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è 3 –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ —É—Ä–æ–≤–Ω—è 0 –¥–æ —É—Ä–æ–≤–Ω—è 1 –Ω—É–∂–Ω–æ 9 –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ —É—Ä–æ–≤–Ω—è 0 (–ø–æ 3 –Ω–∞ –∫–∞–∂–¥–æ–≥–æ)
            const rootPartnersByLevel = {};
            const partnersMaxByLevel = {};
            
            // –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Ö–æ–¥–∏–º –≤—Å–µ—Ö –ø—Ä—è–º—ã—Ö –¥–µ—Ç–µ–π root –∏ –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –∏—Ö –ø–æ —É—Ä–æ–≤–Ω—è–º
            const rootDirectChildren = getDirectChildren('root').filter(card => card.dataset.name && card.dataset.uid);
            rootDirectChildren.forEach(partner => {
                const partnerLevel = parseInt(partner.dataset.level || '0');
                if (!rootPartnersByLevel[partnerLevel]) {
                    rootPartnersByLevel[partnerLevel] = new Set();
                }
                rootPartnersByLevel[partnerLevel].add(partner.dataset.id);
            });
            
            // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–≤–Ω—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ root —Å—á–∏—Ç–∞–µ–º –∏—Ö –ø—Ä—è–º—ã—Ö –¥–µ—Ç–µ–π —Ç–æ–≥–æ –∂–µ —É—Ä–æ–≤–Ω—è
            // –ù–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è 3 –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ —É—Ä–æ–≤–Ω—è 0 –¥–æ —É—Ä–æ–≤–Ω—è 1 –Ω—É–∂–Ω–æ 9 –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ —É—Ä–æ–≤–Ω—è 0 (–ø–æ 3 –Ω–∞ –∫–∞–∂–¥–æ–≥–æ)
            Object.keys(rootPartnersByLevel).forEach(levelStr => {
                const level = parseInt(levelStr);
                const targetLevel = level; // –£—Ä–æ–≤–µ–Ω—å –¥–µ—Ç–µ–π –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ —É—Ä–æ–≤–Ω—è level (—Ç–æ—Ç –∂–µ —É—Ä–æ–≤–µ–Ω—å!)
                
                // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ—Ö –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ root —É—Ä–æ–≤–Ω—è level
                const partnersAtLevel = Array.from(rootPartnersByLevel[level]).map(id => 
                    canvas.querySelector(`.card[data-id="${id}"]`)
                ).filter(card => card);
                
                // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ —É—Ä–æ–≤–Ω—è level –Ω–∞—Ö–æ–¥–∏–º –µ–≥–æ –ø—Ä—è–º—ã—Ö –¥–µ—Ç–µ–π —É—Ä–æ–≤–Ω—è targetLevel (—Ç–æ–≥–æ –∂–µ —É—Ä–æ–≤–Ω—è)
                const childrenAtTargetLevel = new Set();
                partnersAtLevel.forEach(partner => {
                    const directChildren = getDirectChildren(partner.dataset.id)
                        .filter(child => child.dataset.name && child.dataset.uid);
                    directChildren.forEach(child => {
                        const childLevel = parseInt(child.dataset.level || '0');
                        if (childLevel === targetLevel) {
                            childrenAtTargetLevel.add(child.dataset.id);
                        }
                    });
                });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ —É—Ä–æ–≤–Ω—è targetLevel –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ —É—Ä–æ–≤–Ω—è level
                if (!rootPartnersByLevel[targetLevel]) {
                    rootPartnersByLevel[targetLevel] = new Set();
                }
                // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º–∏ —É—Ä–æ–≤–Ω—è targetLevel
                childrenAtTargetLevel.forEach(id => {
                    rootPartnersByLevel[targetLevel].add(id);
                });
                
                // –ú–∞–∫—Å–∏–º—É–º = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ —É—Ä–æ–≤–Ω—è level * 3
                partnersMaxByLevel[targetLevel] = partnersAtLevel.length * 3;
            });
            
            // –î–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è root –Ω—É–∂–Ω—ã 3 –ø–∞—Ä—Ç–Ω–µ—Ä–∞ —É—Ä–æ–≤–Ω—è rootLevel
            const rootPartnersAtRootLevel = rootPartnersByLevel[rootLevel] || new Set();
            const rootNeededForNextLevel = Math.max(0, 3 - rootPartnersAtRootLevel.size);
            const nextLevel = rootLevel + 1;
            
            levelStats[rootLevel] = {
                total: 1,
                filled: 1,
                max: 0,
                neededForNextLevel: rootNeededForNextLevel,
                partnersAtLevel: rootPartnersAtRootLevel.size,
                partnersByLevel: rootPartnersByLevel,
                partnersMaxByLevel: partnersMaxByLevel,
                currentLevel: rootLevel,
                nextLevel: nextLevel
            };
            
            // –î–ª—è —É—Ä–æ–≤–Ω–µ–π –≤—ã—à–µ root —Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä—è–º—ã—Ö –¥–µ—Ç–µ–π –∫–∞—Ä—Ç–æ—á–µ–∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
            for (let level = rootLevel + 1; level <= maxLevel; level++) {
                const prevLevel = level - 1;
                const prevLevelCards = cardsByLevel[prevLevel] || [];
                
                // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö –ø—Ä—è–º—ã—Ö –¥–µ—Ç–µ–π –∫–∞—Ä—Ç–æ—á–µ–∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
                const levelCards = [];
                prevLevelCards.forEach(parentCard => {
                    const children = getDirectChildren(parentCard.dataset.id);
                    levelCards.push(...children);
                });
                
                // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ ID
                const uniqueCards = [];
                const seenIds = new Set();
                levelCards.forEach(card => {
                    if (!seenIds.has(card.dataset.id)) {
                        seenIds.add(card.dataset.id);
                        uniqueCards.push(card);
                    }
                });
                
                cardsByLevel[level] = uniqueCards;
                const filledCards = uniqueCards.filter(card => card.dataset.name && card.dataset.uid);
                
                // –î–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å—á–∏—Ç–∞–µ–º –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ —É—Ä–æ–≤–Ω—è level –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —É—Ä–æ–≤–Ω—è level
                // –ö–∞–∂–¥—ã–π –ø–∞—Ä—Ç–Ω–µ—Ä —É–Ω–∏–∫–∞–ª–µ–Ω –∏ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ ID (–æ–¥–∏–Ω —Ä–∞–∑, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–∞—Ä—Ç–æ—á–µ–∫)
                const levelCardsFilled = filledCards;
                
                // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ —É—Ä–æ–≤–Ω—è level –ø–æ ID
                const uniquePartnersAtLevel = new Set();
                
                levelCardsFilled.forEach(card => {
                    const cardPartners = getDirectChildren(card.dataset.id)
                        .filter(p => p.dataset.name && p.dataset.uid);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ —É—Ä–æ–≤–Ω—è level –≤ Set (—É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ ID)
                    cardPartners.forEach(partner => {
                        const partnerLevel = parseInt(partner.dataset.level || '0');
                        if (partnerLevel === level) {
                            uniquePartnersAtLevel.add(partner.dataset.id);
                        }
                    });
                });
                
                // –ú–∞–∫—Å–∏–º—É–º –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫ —É—Ä–æ–≤–Ω—è level * 3
                const maxPartners = levelCardsFilled.length * 3;
                const partnersAtLevelCount = uniquePartnersAtLevel.size;
                const neededForNextLevel = Math.max(0, maxPartners - partnersAtLevelCount);
                
                levelStats[level] = {
                    total: uniqueCards.length,
                    filled: filledCards.length,
                    max: maxPartners,
                    partnersAtLevel: partnersAtLevelCount,
                    neededForNextLevel: neededForNextLevel
                };
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –¥–æ root —É—Ä–æ–≤–Ω—è
            let html = '';
            for (let level = maxLevel; level >= rootLevel; level--) {
                const stats = levelStats[level];
                if (!stats) continue;
                
                if (level === rootLevel) {
                    // Root –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    const currentLevel = stats.currentLevel || rootLevel;
                    const nextLevel = stats.nextLevel || (rootLevel + 1);
                    const needed = stats.neededForNextLevel || 0;
                    const partnersAtLevel = stats.partnersAtLevel || 0;
                    const partnersByLevel = stats.partnersByLevel || {};
                    const partnersMaxByLevel = stats.partnersMaxByLevel || {};
                    
                    // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    let htmlRoot = '';
                    
                    // –¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–º)
                    htmlRoot += `<div class="stats-item" style="margin-bottom: 8px;">
                        <span class="stats-level" style="color: #3b82f6; font-weight: 600;">${currentLevel} (–≤–∞—à —É—Ä–æ–≤–µ–Ω—å)</span>
                    </div>`;
                    
                    // –ó–∞–≥–æ–ª–æ–≤–æ–∫: –ü–æ–≤—ã—Å–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å (X)
                    htmlRoot += `<div class="stats-item" style="margin-bottom: 8px;">
                        <span class="stats-level" style="color: #3b82f6; font-weight: 600;">–ü–æ–≤—ã—Å–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å (${nextLevel})</span>
                    </div>`;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ —É—Ä–æ–≤–Ω—è currentLevel –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è
                    htmlRoot += `<div class="stats-item" style="margin-bottom: 8px;">
                        <span style="color: ${needed > 0 ? '#ef4444' : '#22c55e'};">
                            ${partnersAtLevel}/3 —É—Ä ${currentLevel}
                        </span>
                    </div>`;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ—Ö –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ –ø–æ —É—Ä–æ–≤–Ω—è–º (–æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É) –≤ —Ñ–æ—Ä–º–∞—Ç–µ X/Y —É—Ä Z
                    const partnerLevels = Object.keys(partnersByLevel).map(l => parseInt(l)).sort((a, b) => b - a);
                    partnerLevels.forEach(partnerLevel => {
                        const count = partnersByLevel[partnerLevel].size;
                        const max = partnersMaxByLevel[partnerLevel] || 0;
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ X/Y —É—Ä Z
                        htmlRoot += `<div class="stats-item">
                            <span style="color: #6b7280;">${count}/${max} —É—Ä ${partnerLevel}</span>
                        </div>`;
                    });
                    
                    html += htmlRoot;
                } else {
                    // –î–ª—è –¥—Ä—É–≥–∏—Ö —É—Ä–æ–≤–Ω–µ–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞—Ö –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è
                    const partnersAtLevel = stats.partnersAtLevel || 0;
                    const needed = stats.neededForNextLevel || 0;
                    const max = stats.max || 0;
                    
                    let displayText;
                    if (max === 0) {
                        displayText = `${stats.filled}`;
                    } else if (needed === 0 && partnersAtLevel >= max) {
                        displayText = `${partnersAtLevel}/${max} (–≥–æ—Ç–æ–≤ –∫ –ø–æ–≤—ã—à–µ–Ω–∏—é)`;
                    } else if (needed > 0) {
                        displayText = `${partnersAtLevel}/${max} (–Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç: ${needed})`;
                    } else {
                        displayText = `${partnersAtLevel}/${max}`;
                    }
                    
                    const color = (needed === 0 && partnersAtLevel >= max && max > 0) ? '#22c55e' : '#ef4444';
                    
                    html += `<div class="stats-item">
                        <span class="stats-level" style="color: #3b82f6;">–£—Ä ${level}</span>
                        <span class="stats-count" style="color: ${color};">${displayText}</span>
                    </div>`;
                }
            }
            
            if (html === '') {
                html = '<div class="stats-item">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            }
            statsContent.innerHTML = html;
        }

        // –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ—á–µ—Ä–Ω–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ root (—Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ, –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ —É–¥–∞–ª—è–µ–º)
        async function clearTestData() {
            const rootCard = canvas.querySelector('.card[data-id="root"]');
            if (!rootCard) return;
            
            // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ –æ–±—ä–µ–∫—Ç—ã root —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ
            function getAllDescendants(parentId) {
                const children = Array.from(canvas.querySelectorAll(`.card[data-parent="${parentId}"]`));
                let allDescendants = [...children];
                children.forEach(child => {
                    allDescendants.push(...getAllDescendants(child.dataset.id));
                });
                return allDescendants;
            }
            
            const rootChildren = getAllDescendants('root');
            
            // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö –¥–æ—á–µ—Ä–Ω–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ root
            rootChildren.forEach(card => {
                delete card.dataset.name;
                delete card.dataset.uid;
                card.dataset.level = '0'; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –Ω–∞ 0
                renderCardContents(card);
            });
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —É—Ä–æ–≤–Ω–∏ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
            const allCards = Array.from(canvas.querySelectorAll('.card'));
            allCards.forEach(card => {
                if (card.dataset.id !== 'root') {
                    recalculateLevel(card);
                }
            });
            
            savePositions();
            updateStats();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const btn = btnClearTestData;
            const originalText = btn.textContent;
            btn.textContent = '‚úì –û—á–∏—â–µ–Ω–æ!';
            btn.style.background = '#22c55e';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#f59e0b';
            }, 2000);
        }
        
        btnClearTestData.onclick = () => clearTestData();
        btnClearAll.onclick = () => resetToRoot();
        
        // –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫—Ä–æ–º–µ root –∏ —Å–±—Ä–æ—Å–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        function resetToRoot() {
            // –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—â–∞–µ–º localStorage, —á—Ç–æ–±—ã –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–µ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å –∫–∞—Ä—Ç–æ—á–∫–∏
            localStorage.removeItem(STORAGE_KEY);
            
            // –ù–∞—Ö–æ–¥–∏–º root –∫–∞—Ä—Ç–æ—á–∫—É
            const root = canvas.querySelector('.card[data-id="root"]');
            const rootId = root ? root.dataset.id : null;
            
            // –£–¥–∞–ª—è–µ–º –í–°–ï –∫–∞—Ä—Ç–æ—á–∫–∏ –∫—Ä–æ–º–µ root
            const allCards = Array.from(canvas.querySelectorAll('.card'));
            allCards.forEach(card => {
                if (card && card.dataset.id !== rootId) {
                    card.remove();
                }
            });
            
            // –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Å–≤—è–∑–∏
            links.innerHTML = '';
            
            // –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            childMap.clear();
            uidCounter = 1;
            
            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å root –∫–∞—Ä—Ç–æ—á–∫—É
            if (root) {
                root.dataset.level = '0';
                root.dataset.parent = '';
                renderCardContents(root);
                // –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ç–æ—á–∫–∏ –∏ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ
                root.querySelectorAll('.point').forEach(p => p.remove());
                attachPoints(root);
                enableDrag(root);
            }
            
            // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—Ç–æ–ª—å–∫–æ root)
            savePositions();
            updateAllConnections();
            updateStats();
        }
    </script>
</body>
</html>


