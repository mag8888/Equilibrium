<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ v3 ‚Äî –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <style>
        :root {
            color-scheme: light;
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            --bg: #f6f7fb;
            --surface: #ffffff;
            --border: #e5e7eb;
            --text: #1f2937;
            --muted: #6b7280;
            --primary: #2563eb;
            --success: #16a34a;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: grid;
            grid-template-rows: auto 1fr auto;
        }
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            padding: 16px 24px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.04);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            color: var(--primary);
        }
        .brand span {
            color: var(--text);
            font-weight: 600;
            text-transform: none;
            letter-spacing: normal;
        }
        .actions {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        button {
            border: 1px solid var(--border);
            background: var(--surface);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        button.primary {
            background: var(--primary);
            color: #fff;
            border-color: transparent;
        }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        button:not(:disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 10px rgba(37, 99, 235, 0.15);
        }
        main {
            display: grid;
            grid-template-columns: minmax(0, 1fr) 320px;
            gap: 16px;
            padding: 16px 24px 24px;
        }
        .canvas-wrap {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            min-height: 560px;
            position: relative;
            overflow: hidden;
        }
        .canvas-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        #tree-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            background: linear-gradient(180deg, #ffffff, #f5f7fb);
        }
        #tree-canvas {
            position: absolute;
            inset: 0;
            transform-origin: 0 0;
        }
        svg.connections {
            position: absolute;
            inset: 0;
            transform-origin: 0 0;
        }
        .tree-node {
            position: absolute;
            padding: 10px 12px;
            background: #fff;
            border-radius: 12px;
            border: 1px solid var(--border);
            min-width: 160px;
            box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .tree-node .title {
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .tree-node .subtitle {
            font-size: 12px;
            color: var(--muted);
        }
        .tree-node .metrics {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 6px;
            font-size: 11px;
            color: var(--muted);
        }
        .panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .panel-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.05);
        }
        .panel-card h2 {
            margin: 0 0 12px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stats-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 13px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }
        .queue-empty {
            text-align: center;
            color: var(--muted);
            font-style: italic;
            margin: 24px 0;
        }
        .queue-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .queue-item {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            background: linear-gradient(180deg, #ffffff, #f8fafc);
            display: grid;
            gap: 6px;
        }
        footer {
            padding: 12px 24px;
            font-size: 12px;
            color: var(--muted);
            background: var(--surface);
            border-top: 1px solid var(--border);
            text-align: right;
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 10px;
            border-radius: 999px;
            background: rgba(37, 99, 235, 0.12);
            color: var(--primary);
            font-size: 12px;
            font-weight: 600;
        }
        .status-badge.success {
            background: rgba(22, 163, 74, 0.14);
            color: var(--success);
        }
        .status-badge.warning {
            background: rgba(234, 179, 8, 0.16);
            color: #b45309;
        }
        .loader {
            position: absolute;
            inset: 0;
            display: grid;
            place-items: center;
            color: var(--muted);
        }
        .toast {
            position: fixed;
            right: 24px;
            bottom: 24px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 14px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.15);
            display: none;
            min-width: 240px;
        }
        .toast.show { display: block; }
        @media (max-width: 1180px) { main { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="brand">‚öôÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ <span>—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º–∏ v3</span></div>
        <div class="actions">
            <button id="btn-reload" class="primary">‚ü≥ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
            <button id="btn-center">–¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
            <button id="btn-fit">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë</button>
            <button id="btn-export">üì• –≠–∫—Å–ø–æ—Ä—Ç</button>
        </div>
    </header>

    <main>
        <section class="canvas-wrap">
            <div class="canvas-toolbar">
                <div class="status-badge" id="data-status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="actions" style="gap:6px;">
                    <button id="btn-zoom-out">‚àí</button>
                    <button id="btn-zoom-reset">100%</button>
                    <button id="btn-zoom-in">+</button>
                </div>
            </div>
            <div id="tree-container">
                <svg class="connections" id="connection-layer"></svg>
                <div id="tree-canvas"></div>
                <div class="loader" id="tree-loader">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã‚Ä¶</div>
            </div>
        </section>

        <aside class="panel">
            <div class="panel-card">
                <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                <div class="stats-list" id="stats-list">
                    <div class="queue-empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
                </div>
            </div>
            <div class="panel-card">
                <div class="canvas-toolbar" style="margin:0;">
                    <h2>üÜï –ù–æ–≤—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</h2>
                    <button id="btn-refresh-queue">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <div id="queue-block">
                    <div class="queue-empty">–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.</div>
                </div>
            </div>
        </aside>
    </main>

    <footer>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ MLM ¬∑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="footer-updated">‚Äî</span></footer>
    <div class="toast" id="toast"></div>

    <script>
        const API_STRUCTURE = '/admin-panel/api/structure-data/';
        const API_QUEUE = '/api/mlm/registrations_queue/';

        const state = {
            data: null,
            stats: null,
            layout: new Map(),
            contentSize: null,
            zoom: 1,
            panX: 0,
            panY: 0,
        };

        const elements = {
            treeCanvas: document.getElementById('tree-canvas'),
            connectionLayer: document.getElementById('connection-layer'),
            treeLoader: document.getElementById('tree-loader'),
            statusBadge: document.getElementById('data-status'),
            statsList: document.getElementById('stats-list'),
            queueBlock: document.getElementById('queue-block'),
            footerUpdated: document.getElementById('footer-updated'),
            toast: document.getElementById('toast'),
            treeContainer: document.getElementById('tree-container'),
        };

        function showToast(message, tone = 'info') {
            elements.toast.textContent = message;
            elements.toast.className = `toast show ${tone}`;
            setTimeout(() => elements.toast.classList.remove('show'), 2200);
        }

        async function fetchJson(url) {
            const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
            if (!res.ok) throw new Error(await res.text() || `HTTP ${res.status}`);
            return res.json();
        }

        function normalizeStructure(payload) {
            const structure = payload && payload.structure;
            if (!structure || !Array.isArray(structure.cards)) {
                return { cards: [], childMap: new Map() };
            }
            const cards = structure.cards.map(card => ({
                id: String(card.id),
                parent: card.parent ? String(card.parent) : null,
                name: card.name || card.username || '‚Äî',
                uid: card.uid || card.username || '',
                level: Number(card.level != null ? card.level : (card.displayLevel != null ? card.displayLevel : 0)),
                raw: card,
            }));
            const childMap = new Map();
            cards.forEach(card => childMap.set(card.id, []));
            if (Array.isArray(structure.childMap)) {
                structure.childMap.forEach(([pid, children]) => childMap.set(String(pid), children.map(String)));
            } else {
                cards.forEach(card => {
                    if (!card.parent) return;
                    if (!childMap.has(card.parent)) childMap.set(card.parent, []);
                    childMap.get(card.parent).push(card.id);
                });
            }
            return { cards, childMap };
        }

        function buildTree(structure) {
            const nodes = new Map();
            structure.cards.forEach(card => nodes.set(card.id, { ...card, children: [] }));
            structure.childMap.forEach((children, pid) => {
                const parent = nodes.get(pid);
                if (!parent) return;
                children.forEach(cid => {
                    const child = nodes.get(cid);
                    if (child) parent.children.push(child);
                });
            });
            let root = structure.cards.find(card => !card.parent) || structure.cards.find(card => card.id === 'root');
            if (!root && structure.cards.length) root = structure.cards[0];
            return { nodes, rootId: root ? root.id : null };
        }

        function layoutTree(tree) {
            const coords = new Map();
            if (!tree.rootId) return coords;
            const GAP_X = 220;
            const GAP_Y = 140;
            let leafIndex = 0;
            function place(nodeId, depth) {
                const node = tree.nodes.get(nodeId);
                if (!node) return 0;
                if (!node.children.length) {
                    const x = leafIndex * GAP_X;
                    leafIndex += 1;
                    coords.set(nodeId, { depth, x });
                    return x;
                }
                const xs = node.children.map(child => place(child.id, depth + 1));
                const avg = xs.reduce((a, b) => a + b, 0) / xs.length;
                coords.set(nodeId, { depth, x: avg });
                return avg;
            }
            place(tree.rootId, 0);
            coords.forEach((value, key) => {
                coords.set(key, { depth: value.depth, x: value.x, y: value.depth * GAP_Y });
            });
            return coords;
        }

        function renderTree(structure) {
            elements.treeCanvas.innerHTML = '';
            elements.connectionLayer.innerHTML = '';
            if (!structure.cards.length) {
                elements.treeLoader.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                elements.treeLoader.style.display = 'grid';
                return;
            }
            elements.treeLoader.style.display = 'none';
            const tree = buildTree(structure);
            const coords = layoutTree(tree);
            state.layout = coords;
            const fragment = document.createDocumentFragment();
            let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
            coords.forEach(({ x, y }) => {
                minX = Math.min(minX, x);
                maxX = Math.max(maxX, x);
                minY = Math.min(minY, y);
                maxY = Math.max(maxY, y);
            });
            const PADDING = 120;
            const width = (maxX - minX || 1) + PADDING * 2;
            const height = (maxY - minY || 1) + PADDING * 2;
            state.contentSize = { width, height };
            elements.treeCanvas.style.width = `${width}px`;
            elements.treeCanvas.style.height = `${height}px`;
            elements.connectionLayer.setAttribute('viewBox', `0 0 ${width} ${height}`);
            elements.connectionLayer.setAttribute('width', width);
            elements.connectionLayer.setAttribute('height', height);
            coords.forEach((pos, nodeId) => {
                const nodeData = tree.nodes.get(nodeId);
                if (!nodeData) return;
                const left = pos.x - minX + PADDING;
                const top = pos.y - minY + PADDING;
                const node = document.createElement('div');
                node.className = `tree-node level-${nodeData.level}`;
                node.style.left = `${left}px`;
                node.style.top = `${top}px`;
                node.innerHTML = `
                    <div class=\"title\">${nodeData.level === 0 ? 'üåê' : 'üë§'} ${nodeData.name}</div>
                    <div class=\"subtitle\">ID ${nodeData.uid || '‚Äî'}</div>
                    <div class=\"metrics\">
                        <div>–£—Ä–æ–≤–µ–Ω—å: <strong>${nodeData.level}</strong></div>
                        <div>–ü—Ä—è–º—ã—Ö: <strong>${nodeData.raw.directReferrals != null ? nodeData.raw.directReferrals : 0}</strong></div>
                        <div>–í—Å–µ–≥–æ: <strong>${nodeData.raw.totalReferrals != null ? nodeData.raw.totalReferrals : 0}</strong></div>
                        <div>–ë–æ–Ω—É—Å: <strong>${nodeData.raw.bonusYellow != null ? nodeData.raw.bonusYellow : 0}$</strong></div>
                    </div>`;
                fragment.appendChild(node);
            });
            elements.treeCanvas.appendChild(fragment);
            const svgNs = 'http://www.w3.org/2000/svg';
            tree.nodes.forEach(node => {
                if (!node.parent) return;
                const parentPos = coords.get(node.parent);
                const childPos = coords.get(node.id);
                if (!parentPos || !childPos) return;
                const startX = parentPos.x - minX + PADDING;
                const startY = parentPos.y - minY + PADDING;
                const endX = childPos.x - minX + PADDING;
                const endY = childPos.y - minY + PADDING;
                const dy = Math.max(60, (endY - startY) * 0.6);
                const path = document.createElementNS(svgNs, 'path');
                path.setAttribute('d', `M ${startX} ${startY} C ${startX} ${startY + dy}, ${endX} ${endY - dy}, ${endX} ${endY}`);
                path.setAttribute('stroke', 'rgba(37,99,235,0.45)');
                path.setAttribute('stroke-width', '2.4');
                path.setAttribute('fill', 'none');
                elements.connectionLayer.appendChild(path);
            });
            fitToView();
        }

        function applyTransform() {
            const transform = `translate(${state.panX}px, ${state.panY}px) scale(${state.zoom})`;
            elements.treeCanvas.style.transform = transform;
            elements.connectionLayer.style.transform = transform;
            document.getElementById('btn-zoom-reset').textContent = `${Math.round(state.zoom * 100)}%`;
        }

        function fitToView() {
            if (!state.contentSize) return;
            const { width, height } = state.contentSize;
            const availableW = elements.treeContainer.clientWidth - 40;
            const availableH = elements.treeContainer.clientHeight - 40;
            const scale = Math.min(1, availableW / width, availableH / height);
            state.zoom = scale;
            state.panX = (elements.treeContainer.clientWidth - width * scale) / 2;
            state.panY = (elements.treeContainer.clientHeight - height * scale) / 2;
            applyTransform();
        }

        function updateStats(stats) {
            if (!stats) {
                elements.statsList.innerHTML = '<div class=\"queue-empty\">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>';
                return;
            }
            const rows = [];
            const totals = stats.totals || {};
            rows.push(`<div class="stat-row"><span>–í—Å–µ–≥–æ —É–∑–ª–æ–≤</span><span>${totals.nodes != null ? totals.nodes : 0}</span></div>`);
            rows.push(`<div class="stat-row"><span>–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</span><span>${totals.partners != null ? totals.partners : 0}</span></div>`);
            rows.push(`<div class="stat-row"><span>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span><span>${totals.participants != null ? totals.participants : 0}</span></div>`);
            const root = stats.root || {};
            if (root.name) {
                rows.push(`<div class="stat-row"><span>–ö–æ—Ä–Ω–µ–≤–æ–π –ø–∞—Ä—Ç–Ω—ë—Ä</span><span>${root.name}</span></div>`);
                rows.push(`<div class="stat-row"><span>–ü—Ä—è–º—ã—Ö –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</span><span>${root.direct_referrals != null ? root.direct_referrals : 0}</span></div>`);
            }
            if (Array.isArray(stats.levels)) {
                stats.levels.forEach(level => {
                    rows.push(`<div class="stat-row"><span>–£—Ä–æ–≤–µ–Ω—å ${level.level}</span><span>${level.total}</span></div>`);
                });
            }
            elements.statsList.innerHTML = rows.join('');
            if (stats.generated_at) elements.footerUpdated.textContent = new Date(stats.generated_at).toLocaleString();
        }

        async function loadStructure() {
            try {
                elements.statusBadge.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶';
                elements.statusBadge.className = 'status-badge';
                const payload = await fetchJson(API_STRUCTURE);
                const normalized = normalizeStructure(payload);
                state.data = normalized;
                state.stats = payload.stats || null;
                renderTree(normalized);
                updateStats(payload.stats);
                elements.statusBadge.textContent = '–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã';
                elements.statusBadge.className = 'status-badge success';
            } catch (error) {
                console.error(error);
                elements.treeLoader.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                elements.statusBadge.textContent = '–û—à–∏–±–∫–∞';
                elements.statusBadge.className = 'status-badge warning';
                showToast(error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É', 'warning');
            }
        }

        async function loadQueue() {
            try {
                const data = await fetchJson(API_QUEUE);
                const items = Array.isArray(data.items) ? data.items : [];
                if (!items.length) {
                    elements.queueBlock.innerHTML = '<div class=\"queue-empty\">–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.</div>';
                    return;
                }
                const listHtml = items.map(item => `
                    <div class=\"queue-item\">
                        <div class=\"title\">üë§ ${item.username}</div>
                        <div class=\"meta\">ID: ${item.referral_code != null ? item.referral_code : '‚Äî'} ¬∑ –ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å: ${item.invited_by != null ? item.invited_by : '‚Äî'}</div>
                        <div class=\"meta\">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: ${new Date(item.registered_at).toLocaleString()}</div>
                        <div class=\"meta\">–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã: ${item.payment_status != null ? item.payment_status : '‚Äî'}</div>
                    </div>`).join('');
                elements.queueBlock.innerHTML = `<div class=\"queue-list\">${listHtml}</div>`;
            } catch (error) {
                console.error(error);
                elements.queueBlock.innerHTML = '<div class=\"queue-empty\">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—á–µ—Ä–µ–¥—å.</div>';
            }
        }

        function exportStructure() {
            if (!state.data) {
                showToast('–î–∞–Ω–Ω—ã–µ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'warning');
                return;
            }
            const payload = {
                generated_at: new Date().toISOString(),
                structure: state.data,
                stats: state.stats,
            };
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `structure_${Date.now()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            showToast('–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞', 'success');
        }

        function setupControls() {
            const fitHandler = () => fitToView();
            document.getElementById('btn-reload').addEventListener('click', () => { loadStructure(); loadQueue(); });
            document.getElementById('btn-refresh-queue').addEventListener('click', loadQueue);
            document.getElementById('btn-export').addEventListener('click', exportStructure);
            document.getElementById('btn-center').addEventListener('click', fitHandler);
            document.getElementById('btn-fit').addEventListener('click', fitHandler);
            document.getElementById('btn-zoom-reset').addEventListener('click', fitHandler);
            document.getElementById('btn-zoom-in').addEventListener('click', () => { state.zoom = Math.min(2, state.zoom + 0.1); applyTransform(); });
            document.getElementById('btn-zoom-out').addEventListener('click', () => { state.zoom = Math.max(0.3, state.zoom - 0.1); applyTransform(); });
            elements.treeContainer.addEventListener('wheel', event => {
                event.preventDefault();
                const delta = event.deltaY < 0 ? 0.05 : -0.05;
                state.zoom = Math.min(2, Math.max(0.3, state.zoom + delta));
                applyTransform();
            }, { passive: false });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            setupControls();
            await loadStructure();
            await loadQueue();
        });
    </script>
</body>
</html>

