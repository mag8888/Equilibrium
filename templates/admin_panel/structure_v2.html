<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Структура v2 — Сетка, панорамирование, перетаскивание</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .toolbar { position: fixed; top: 10px; left: 10px; z-index: 1000; display: flex; gap: 8px; background: rgba(255,255,255,0.9); padding: 8px 10px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); }
        .btn { padding: 6px 10px; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; }
        .viewport { position: relative; width: 100vw; height: 100vh; overflow: hidden; background: #fafafa; }
        .canvas { position: absolute; top: 0; left: 0; width: 5000px; height: 5000px; transform-origin: 0 0; }
        .grid { position: absolute; inset: 0; background-image: linear-gradient(#eee 1px, transparent 1px), linear-gradient(90deg, #eee 1px, transparent 1px); background-size: 40px 40px, 40px 40px; pointer-events: none; }
        .grid.heavy { background-image: linear-gradient(#eee 1px, transparent 1px), linear-gradient(90deg, #eee 1px, transparent 1px), linear-gradient(#e2e8f0 1px, transparent 1px), linear-gradient(90deg, #e2e8f0 1px, transparent 1px); background-size: 40px 40px, 40px 40px, 200px 200px, 200px 200px; }
        .card { position: absolute; min-width: 140px; min-height: 64px; padding: 10px 12px; background: white; border: 2px solid #cbd5e1; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); cursor: grab; user-select: none; transition: box-shadow 0.15s ease; }
        .card:hover { box-shadow: 0 6px 18px rgba(0,0,0,0.1); }
        .card.dragging { cursor: grabbing; z-index: 2000; }
    </style>
</head>
<body>
    <div class="toolbar">
        <button class="btn" id="toggleGrid">Скрыть сетку</button>
        <button class="btn" id="center">Центрировать</button>
        <button class="btn" id="snap">Привязка к сетке: Вкл</button>
        <button class="btn" id="zoomOut">−</button>
        <button class="btn" id="zoomIn">+</button>
    </div>
    <div class="viewport" id="viewport">
        <div class="canvas" id="canvas">
            <div class="grid heavy" id="grid"></div>
            <!-- Авто-раскладка примера по уровням -->
            <div class="card" data-id="root" style="left: 2400px; top: 200px;">IVA • Level 0</div>
            <div class="card" data-id="l1-1" style="left: 2000px; top: 400px;">L1 • 1</div>
            <div class="card" data-id="l1-2" style="left: 2400px; top: 400px;">L1 • 2</div>
            <div class="card" data-id="l1-3" style="left: 2800px; top: 400px;">L1 • 3</div>
            <div class="card" data-id="l2-1" style="left: 1840px; top: 600px;">L2 • 1</div>
            <div class="card" data-id="l2-2" style="left: 2000px; top: 600px;">L2 • 2</div>
            <div class="card" data-id="l2-3" style="left: 2160px; top: 600px;">L2 • 3</div>
            <div class="card" data-id="l2-4" style="left: 2240px; top: 600px;">L2 • 4</div>
            <div class="card" data-id="l2-5" style="left: 2560px; top: 600px;">L2 • 5</div>
            <div class="card" data-id="l2-6" style="left: 2640px; top: 600px;">L2 • 6</div>
            <div class="card" data-id="l2-7" style="left: 2800px; top: 600px;">L2 • 7</div>
            <div class="card" data-id="l2-8" style="left: 2960px; top: 600px;">L2 • 8</div>
        </div>
    </div>

    <script>
        const GRID_SIZE = 40;
        const viewport = document.getElementById('viewport');
        const canvas = document.getElementById('canvas');
        const grid = document.getElementById('grid');
        const btnGrid = document.getElementById('toggleGrid');
        const btnCenter = document.getElementById('center');
        const btnSnap = document.getElementById('snap');
        const btnZoomIn = document.getElementById('zoomIn');
        const btnZoomOut = document.getElementById('zoomOut');

        let scale = 1; // 0.5..2
        let offsetX = 0; // панорама
        let offsetY = 0;
        let isPanning = false;
        let panStartX = 0, panStartY = 0;
        let canvasStartX = 0, canvasStartY = 0;
        let snapEnabled = true;

        function applyTransform() {
            canvas.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
        }

        // Панорамирование по пустому месту
        viewport.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('card')) return;
            isPanning = true;
            panStartX = e.clientX;
            panStartY = e.clientY;
            canvasStartX = offsetX;
            canvasStartY = offsetY;
        });
        window.addEventListener('mousemove', (e) => {
            if (!isPanning) return;
            offsetX = canvasStartX + (e.clientX - panStartX);
            offsetY = canvasStartY + (e.clientY - panStartY);
            applyTransform();
        });
        window.addEventListener('mouseup', () => { isPanning = false; });

        // Зум колёсиком
        viewport.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY < 0 ? 1.1 : 0.9;
            const prevScale = scale;
            scale = Math.min(2, Math.max(0.5, scale * delta));
            // Масштаб вокруг курсора
            const rect = viewport.getBoundingClientRect();
            const cx = e.clientX - rect.left;
            const cy = e.clientY - rect.top;
            offsetX = cx - (cx - offsetX) * (scale / prevScale);
            offsetY = cy - (cy - offsetY) * (scale / prevScale);
            applyTransform();
        }, { passive: false });

        btnZoomIn.onclick = () => { scale = Math.min(2, scale * 1.1); applyTransform(); };
        btnZoomOut.onclick = () => { scale = Math.max(0.5, scale * 0.9); applyTransform(); };
        btnCenter.onclick = () => { offsetX = (viewport.clientWidth - 5000) / 2; offsetY = 120; applyTransform(); };

        // Переключатель сетки
        let gridVisible = true;
        btnGrid.onclick = () => {
            gridVisible = !gridVisible;
            grid.style.display = gridVisible ? 'block' : 'none';
            btnGrid.textContent = gridVisible ? 'Скрыть сетку' : 'Показать сетку';
        };
        btnSnap.onclick = () => {
            snapEnabled = !snapEnabled;
            btnSnap.textContent = `Привязка к сетке: ${snapEnabled ? 'Вкл' : 'Выкл'}`;
        };

        // Drag карточек
        let dragging = null;
        let dragOffsetX = 0, dragOffsetY = 0;
        let startLeft = 0, startTop = 0;

        function toCanvasCoords(clientX, clientY) {
            const rect = viewport.getBoundingClientRect();
            const x = (clientX - rect.left - offsetX) / scale;
            const y = (clientY - rect.top - offsetY) / scale;
            return { x, y };
        }

        canvas.addEventListener('mousedown', (e) => {
            const card = e.target.closest('.card');
            if (!card) return;
            dragging = card;
            dragging.classList.add('dragging');
            const { x, y } = toCanvasCoords(e.clientX, e.clientY);
            startLeft = parseInt(card.style.left) || 0;
            startTop = parseInt(card.style.top) || 0;
            dragOffsetX = x - startLeft;
            dragOffsetY = y - startTop;
            e.preventDefault();
        });

        window.addEventListener('mousemove', (e) => {
            if (!dragging) return;
            const { x, y } = toCanvasCoords(e.clientX, e.clientY);
            const nx = x - dragOffsetX;
            const ny = y - dragOffsetY;
            dragging.style.left = nx + 'px';
            dragging.style.top = ny + 'px';
        });
        window.addEventListener('mouseup', () => {
            if (!dragging) return;
            if (snapEnabled) {
                const nx = Math.round((parseInt(dragging.style.left) || 0) / GRID_SIZE) * GRID_SIZE;
                const ny = Math.round((parseInt(dragging.style.top) || 0) / GRID_SIZE) * GRID_SIZE;
                dragging.style.left = nx + 'px';
                dragging.style.top = ny + 'px';
            }
            dragging.classList.remove('dragging');
            dragging = null;
        });

        // Старт
        btnCenter.click();
    </script>
</body>
</html>


