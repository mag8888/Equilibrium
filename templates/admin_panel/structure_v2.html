<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ v2 ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º–∏</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f4f6fb;
            color: #1f2937;
        }
        .layout {
            display: grid;
            grid-template-columns: minmax(0, 1fr) 320px;
            grid-template-rows: auto 1fr;
            grid-template-areas: "header header" "canvas sidebar";
            min-height: 100vh;
        }
        header {
            grid-area: header;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 16px 24px;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.05);
        }
        header .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 16px;
        }
        .controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        button {
            border: 1px solid #d1d5db;
            background: #fff;
            color: #1f2937;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s ease, box-shadow 0.15s ease;
        }
        button.primary {
            background: #2563eb;
            color: #fff;
            border-color: transparent;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        button:not(:disabled):hover {
            background: #f8fafc;
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
        }
        main {
            grid-area: canvas;
            padding: 16px 24px 24px 24px;
        }
        .canvas-container {
            background: linear-gradient(180deg, #ffffff, #f4f6fb);
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            height: calc(100vh - 120px);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .canvas-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            background: rgba(255,255,255,0.85);
        }
        #canvas {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-image: linear-gradient(#e5e7eb 1px, transparent 1px), linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
            background-size: 40px 40px;
        }
        #canvasInner {
            position: absolute;
            inset: 0;
            transform-origin: 0 0;
        }
        svg#connections {
            position: absolute;
            inset: 0;
            transform-origin: 0 0;
        }
        .card {
            position: absolute;
            width: 200px;
            padding: 16px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 18px 34px rgba(15, 23, 42, 0.12);
            border: 1px solid rgba(15, 23, 42, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            transform-origin: center;
        }
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .card .title {
            font-size: 16px;
            font-weight: 600;
            color: #0f172a;
        }
        .card-add-btn {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            border: none;
            background: #2563eb;
            color: white;
            display: grid;
            place-items: center;
            font-size: 18px;
            line-height: 1;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        .card-add-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(37, 99, 235, 0.25);
        }
        .card .subtitle {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 12px;
        }
        .card .stats {
            font-size: 12px;
            color: #475569;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px 12px;
            margin-bottom: 12px;
        }
        .card .financial {
            display: grid;
            grid-template-columns: 1fr;
            gap: 4px;
            font-size: 12px;
            color: #334155;
        }
        .card .stats strong {
            color: #0f172a;
        }
        .card .financial strong {
            color: #15803d;
        }
        .card .financial .transition strong {
            color: #b45309;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 26px 48px rgba(15, 23, 42, 0.18);
        }
        aside {
            grid-area: sidebar;
            padding: 16px 24px 24px 0;
        }
        .sidebar-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
        }
        .sidebar-card h3 {
            margin: 0 0 12px;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .stats-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            font-size: 13px;
        }
        .queue-empty {
            text-align: center;
            color: #94a3b8;
            font-style: italic;
        }
        .queue-item {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 10px 12px;
            background: linear-gradient(180deg, #ffffff, #f8fafc);
            display: grid;
            gap: 6px;
            margin-bottom: 10px;
            font-size: 13px;
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 10px;
            border-radius: 999px;
            background: rgba(37, 99, 235, 0.12);
            color: #2563eb;
            font-size: 12px;
            font-weight: 600;
        }
        .status-badge.success {
            background: rgba(16, 185, 129, 0.15);
            color: #047857;
        }
        .status-badge.warning {
            background: rgba(251, 191, 36, 0.18);
            color: #b45309;
        }
        .toast {
            position: fixed;
            right: 24px;
            bottom: 24px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.18);
            display: none;
            min-width: 220px;
        }
        .toast.show { display: block; }
        footer {
            grid-column: 1 / -1;
            padding: 12px 24px;
            font-size: 12px;
            color: #6b7280;
            background: #ffffff;
            border-top: 1px solid #e5e7eb;
            text-align: right;
        }
        @media (max-width: 1200px) {
            .layout {
                grid-template-columns: 1fr;
                grid-template-areas: "header" "canvas" "sidebar";
            }
            aside {
                padding: 0 24px 24px;
            }
        }
    </style>
</head>
<body>
    <div class="layout">
        <header>
            <div class="brand">‚öôÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ ¬∑ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</div>
            <div class="controls">
                <button id="btn-reload" class="primary">‚ü≥ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                <button id="btn-fit">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë</button>
                <button id="btn-center">–¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                <button id="btn-export">–≠–∫—Å–ø–æ—Ä—Ç</button>
            </div>
        </header>

        <main>
            <div class="canvas-container">
                <div class="canvas-toolbar">
                    <div class="status-badge" id="status-badge">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
                    <div class="controls" style="gap:6px;">
                        <button id="btn-zoom-out">‚àí</button>
                        <button id="btn-zoom-reset">100%</button>
                        <button id="btn-zoom-in">+</button>
                    </div>
                </div>
                <div id="canvas">
                    <svg id="connections"></svg>
                    <div id="canvasInner"></div>
                    <div class="queue-empty" id="canvas-loader" style="position:absolute; inset:0; display:grid; place-items:center; background: rgba(255,255,255,0.6);">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã‚Ä¶</div>
                </div>
            </div>
        </main>

        <aside>
            <div class="sidebar-card" id="stats-card">
                <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div class="stats-list" id="stats-list">
                    <div class="queue-empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                </div>
                <div style="margin-top:12px; font-size:12px; color:#94a3b8;">–û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="stats-updated">‚Äî</span></div>
            </div>
            <div class="sidebar-card">
                <div class="controls" style="justify-content: space-between;">
                    <h3 style="margin:0;">üÜï –ù–æ–≤—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</h3>
                    <button id="btn-refresh-queue">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <div id="queue-block" style="margin-top:12px;">
                    <div class="queue-empty">–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.</div>
                </div>
            </div>
        </aside>

        <footer>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ MLM ¬∑ <span id="footer-status">‚Äî</span></footer>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const API_STRUCTURE = '/admin-panel/api/structure-data/';
        const API_QUEUE = '/api/mlm/registrations_queue/';

        const $ = (id) => document.getElementById(id);

        const refs = {
            canvas: $('canvas'),
            canvasInner: $('canvasInner'),
            connections: $('connections'),
            loader: $('canvas-loader'),
            status: $('status-badge'),
            statsList: $('stats-list'),
            statsUpdated: $('stats-updated'),
            queueBlock: $('queue-block'),
            footerStatus: $('footer-status'),
            toast: $('toast'),
        };

        const state = {
            zoom: 1,
            panX: 0,
            panY: 0,
            contentWidth: 0,
            contentHeight: 0,
            structure: null,
            stats: null,
        };

        function showToast(message) {
            refs.toast.textContent = message;
            refs.toast.classList.add('show');
            setTimeout(() => refs.toast.classList.remove('show'), 2200);
        }

        function formatMoney(value) {
            const amount = Number(value || 0);
            if (!Number.isFinite(amount)) return '$0';
            return `$${amount.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            })}`;
        }

        function getCookie(name) {
            const cookies = document.cookie ? document.cookie.split('; ') : [];
            for (const cookie of cookies) {
                const [key, ...rest] = cookie.split('=');
                if (key === name) {
                    return decodeURIComponent(rest.join('='));
                }
            }
            return null;
        }

        async function fetchJson(url) {
            const response = await fetch(url, {
                headers: { 'Accept': 'application/json' },
                credentials: 'same-origin',
            });
            const rawText = await response.text();
            if (!response.ok) {
                throw new Error(rawText || `HTTP ${response.status}`);
            }
            try {
                return JSON.parse(rawText);
            } catch (error) {
                throw new Error('–ü–æ–ª—É—á–µ–Ω –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.');
            }
        }

        async function registerPartner(inviterUid) {
            try {
                refs.status.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º‚Ä¶';
                refs.status.className = 'status-badge';
                const response = await fetch('/api/mlm/register_partner/', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') || '',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ inviter_uid: inviterUid }),
                });
                const raw = await response.text();
                if (!response.ok) {
                    throw new Error(raw || `HTTP ${response.status}`);
                }
                let payload = null;
                try {
                    payload = raw ? JSON.parse(raw) : null;
                } catch (error) {
                    throw new Error('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω, –Ω–æ –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω.');
                }
                showToast('–ü–∞—Ä—Ç–Ω—ë—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –æ—á–µ—Ä–µ–¥—å.');
                refs.status.textContent = '–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã';
                refs.status.className = 'status-badge success';
                await Promise.all([loadQueue(), loadStructure()]);
                return payload;
            } catch (error) {
                console.error(error);
                showToast(error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä–∞');
                refs.status.textContent = '–û—à–∏–±–∫–∞';
                refs.status.className = 'status-badge warning';
                throw error;
            }
        }

        function ensureRoot(structure, stats) {
            if (!structure || !Array.isArray(structure.cards)) {
                return {
                    cards: [{
                        id: 'root',
                        parent: null,
                        name: stats && stats.root && stats.root.name ? stats.root.name : 'admin',
                        uid: stats && stats.root && stats.root.username ? stats.root.username : '0000001',
                        level: stats && stats.root && stats.root.level ? stats.root.level : 0,
                        directReferrals: stats && stats.root && stats.root.direct_referrals ? stats.root.direct_referrals : 0,
                        totalReferrals: stats && stats.root && stats.root.total_descendants ? stats.root.total_descendants : 0,
                    }],
                    childMap: [],
                };
            }
            const hasRoot = structure.cards.some(card => card && String(card.id) === 'root');
            if (!hasRoot) {
                const rootStats = stats && stats.root ? stats.root : {};
                structure.cards.unshift({
                    id: 'root',
                    parent: null,
                    name: rootStats.name || rootStats.username || 'admin',
                    uid: rootStats.username || '0000001',
                    level: rootStats.level || 0,
                    directReferrals: rootStats.direct_referrals || 0,
                    totalReferrals: rootStats.total_descendants || 0,
                });
            }
            if (!Array.isArray(structure.childMap)) {
                structure.childMap = [];
            }
            return structure;
        }

        function buildTree(structure) {
            const nodes = new Map();
            structure.cards.forEach(card => {
                if (!card) return;
                nodes.set(String(card.id), {
                    id: String(card.id),
                    parent: card.parent ? String(card.parent) : null,
                    name: card.name || card.username || '‚Äî',
                    uid: card.uid || card.username || '',
                    level: Number(card.level || card.displayLevel || 0),
                    direct: card.directReferrals != null ? card.directReferrals : 0,
                    total: card.totalReferrals != null ? card.totalReferrals : 0,
                    bonus: card.bonusYellow != null ? card.bonusYellow : 0,
                    payout: card.payoutGreen != null ? card.payoutGreen : 0,
                    children: [],
                });
            });
            structure.childMap.forEach(entry => {
                const parentId = String(entry[0]);
                const children = entry[1] || [];
                if (!nodes.has(parentId)) return;
                const parent = nodes.get(parentId);
                children.forEach(childId => {
                    const child = nodes.get(String(childId));
                    if (child) parent.children.push(child.id);
                });
            });
            let root = Array.from(nodes.values()).find(node => !node.parent) || nodes.get('root');
            if (!root && nodes.size > 0) root = Array.from(nodes.values())[0];
            return { nodes, rootId: root ? root.id : null };
        }

        function layoutTree(tree) {
            const positions = new Map();
            if (!tree.rootId) return positions;
            const GAP_X = 220;
            const GAP_Y = 140;
            let leaf = 0;
            function place(id, depth) {
                const node = tree.nodes.get(id);
                if (!node) return 0;
                if (!node.children.length) {
                    const x = leaf * GAP_X;
                    leaf += 1;
                    positions.set(id, { depth, x });
                    return x;
                }
                const xs = node.children.map(child => place(child, depth + 1));
                const avg = xs.reduce((a, b) => a + b, 0) / xs.length;
                positions.set(id, { depth, x: avg });
                return avg;
            }
            place(tree.rootId, 0);
            positions.forEach((pos, id) => {
                positions.set(id, { depth: pos.depth, x: pos.x, y: pos.depth * GAP_Y });
            });
            return positions;
        }

        function renderTree(structure) {
            refs.canvasInner.innerHTML = '';
            refs.connections.innerHTML = '';
            if (!structure.cards.length) {
                refs.loader.style.display = 'grid';
                refs.loader.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                return;
            }
            refs.loader.style.display = 'none';
            const tree = buildTree(structure);
            const positions = layoutTree(tree);
            let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
            positions.forEach(({ x, y }) => {
                minX = Math.min(minX, x);
                maxX = Math.max(maxX, x);
                minY = Math.min(minY, y);
                maxY = Math.max(maxY, y);
            });
            const padding = 120;
            const width = (maxX - minX || 1) + padding * 2;
            const height = (maxY - minY || 1) + padding * 2;
            state.contentWidth = width;
            state.contentHeight = height;
            refs.canvasInner.style.width = `${width}px`;
            refs.canvasInner.style.height = `${height}px`;
            refs.connections.setAttribute('viewBox', `0 0 ${width} ${height}`);
            refs.connections.setAttribute('width', width);
            refs.connections.setAttribute('height', height);
            const fragment = document.createDocumentFragment();
            positions.forEach((pos, id) => {
                const node = tree.nodes.get(id);
                if (!node) return;
                const left = pos.x - minX + padding;
                const top = pos.y - minY + padding;
                const el = document.createElement('div');
                el.className = 'card';
                el.style.left = `${left}px`;
                el.style.top = `${top}px`;
                el.innerHTML = `
                    <div class="card-header">
                        <div class="title">${node.level === 0 ? 'üåê' : 'üë§'} ${node.name}</div>
                        <button class="card-add-btn" title="–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä–∞" data-uid="${node.uid}" ${node.uid ? '' : 'disabled'}>+</button>
                    </div>
                    <div class="subtitle">ID ${node.uid || '‚Äî'}</div>
                    <div class="stats">
                        <div>–£—Ä–æ–≤–µ–Ω—å: <strong>${node.level}</strong></div>
                        <div>–ü—Ä—è–º—ã—Ö: <strong>${node.direct}</strong></div>
                        <div>–í—Å–µ–≥–æ: <strong>${node.total}</strong></div>
                        <div>–°—Ç–∞—Ç—É—Å: <strong>${node.children.length > 0 ? '–ê–∫—Ç–∏–≤–µ–Ω' : '‚Äî'}</strong></div>
                    </div>
                    <div class="financial">
                        <div class="payout">üü¢ –í—ã–ø–ª–∞—Ç—ã: <strong>${formatMoney(node.payout)}</strong></div>
                        <div class="transition">üü° –ü–µ—Ä–µ—Ö–æ–¥–Ω—ã–π: <strong>${formatMoney(node.bonus)}</strong></div>
                    </div>`;
                fragment.appendChild(el);
                const addBtn = el.querySelector('.card-add-btn');
                if (addBtn && node.uid) {
                    addBtn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        addBtn.disabled = true;
                        registerPartner(node.uid).finally(() => {
                            addBtn.disabled = false;
                        });
                    });
                }
            });
            refs.canvasInner.appendChild(fragment);
            const svgNs = 'http://www.w3.org/2000/svg';
            tree.nodes.forEach(node => {
                if (!node.parent) return;
                const parentPos = positions.get(node.parent);
                const childPos = positions.get(node.id);
                if (!parentPos || !childPos) return;
                const startX = parentPos.x - minX + padding;
                const startY = parentPos.y - minY + padding;
                const endX = childPos.x - minX + padding;
                const endY = childPos.y - minY + padding;
                const dy = Math.max(60, (endY - startY) * 0.6);
                const path = document.createElementNS(svgNs, 'path');
                path.setAttribute('d', `M ${startX} ${startY} C ${startX} ${startY + dy}, ${endX} ${endY - dy}, ${endX} ${endY}`);
                path.setAttribute('stroke', 'rgba(37,99,235,0.45)');
                path.setAttribute('stroke-width', '2.4');
                path.setAttribute('fill', 'none');
                refs.connections.appendChild(path);
            });
            fitToView();
        }

        function applyTransform() {
            const container = refs.canvas.getBoundingClientRect();
            const contentW = state.contentWidth * state.zoom;
            const contentH = state.contentHeight * state.zoom;
            const minX = Math.min(0, container.width - contentW);
            const minY = Math.min(0, container.height - contentH);
            state.panX = Math.min(Math.max(state.panX, minX), 0);
            state.panY = Math.min(Math.max(state.panY, minY), 0);
            const transform = `translate(${state.panX}px, ${state.panY}px) scale(${state.zoom})`;
            refs.canvasInner.style.transform = transform;
            refs.connections.style.transform = transform;
            $('btn-zoom-reset').textContent = `${Math.round(state.zoom * 100)}%`;
        }

        function fitToView() {
            const container = refs.canvas.getBoundingClientRect();
            if (!state.contentWidth || !state.contentHeight) return;
            const scale = Math.min(1, (container.width - 40) / state.contentWidth, (container.height - 40) / state.contentHeight);
            state.zoom = scale;
            state.panX = (container.width - state.contentWidth * scale) / 2;
            state.panY = (container.height - state.contentHeight * scale) / 2;
            applyTransform();
        }

        function renderStats(stats) {
            if (!stats) {
                refs.statsList.innerHTML = '<div class="queue-empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>';
                return;
            }
            const totals = stats.totals || {};
            const rows = [
                `<div class="stat-row"><span>–í—Å–µ–≥–æ —É–∑–ª–æ–≤</span><span>${totals.nodes != null ? totals.nodes : 0}</span></div>`,
                `<div class="stat-row"><span>–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</span><span>${totals.partners != null ? totals.partners : 0}</span></div>`,
                `<div class="stat-row"><span>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span><span>${totals.participants != null ? totals.participants : 0}</span></div>`
            ];
            const root = stats.root || {};
            if (root.name) {
                rows.push(`<div class="stat-row"><span>–ö–æ—Ä–Ω–µ–≤–æ–π –ø–∞—Ä—Ç–Ω—ë—Ä</span><span>${root.name}</span></div>`);
                rows.push(`<div class="stat-row"><span>–ü—Ä—è–º—ã–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</span><span>${root.direct_referrals != null ? root.direct_referrals : 0}</span></div>`);
            }
            if (Array.isArray(stats.levels)) {
                stats.levels.forEach(level => {
                    rows.push(`<div class="stat-row"><span>–£—Ä–æ–≤–µ–Ω—å ${level.level}</span><span>${level.total}</span></div>`);
                });
            }
            refs.statsList.innerHTML = rows.join('');
            if (stats.generated_at) {
                const ts = new Date(stats.generated_at).toLocaleString();
                refs.statsUpdated.textContent = ts;
                refs.footerStatus.textContent = ts;
            }
        }

        function renderQueue(items) {
            if (!items || !items.length) {
                refs.queueBlock.innerHTML = '<div class="queue-empty">–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.</div>';
                return;
            }
            const html = items.map(item => {
                const inviter = item.invited_by != null ? item.invited_by : '‚Äî';
                const payment = item.payment_status != null ? item.payment_status : '‚Äî';
                const registered = item.registered_at ? new Date(item.registered_at).toLocaleString() : '‚Äî';
                const ref = item.referral_code != null ? item.referral_code : '‚Äî';
                return `
                    <div class="queue-item">
                        <div>üë§ ${item.username}</div>
                        <div style="font-size:12px; color:#6b7280">ID: ${ref} ¬∑ –ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å: ${inviter}</div>
                        <div style="font-size:12px; color:#6b7280">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: ${registered}</div>
                        <div style="font-size:12px; color:#6b7280">–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã: ${payment}</div>
                    </div>`;
            }).join('');
            refs.queueBlock.innerHTML = html;
        }

        async function loadStructure() {
            try {
                refs.loader.style.display = 'grid';
                refs.status.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶';
                refs.status.className = 'status-badge';
                const payload = await fetchJson(API_STRUCTURE);
                const structure = ensureRoot(payload.structure, payload.stats);
                state.structure = structure;
                state.stats = payload.stats || null;
                renderTree(structure);
                renderStats(state.stats);
                refs.status.textContent = '–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã';
                refs.status.className = 'status-badge success';
            } catch (error) {
                console.error(error);
                refs.loader.style.display = 'grid';
                refs.loader.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                refs.status.textContent = '–û—à–∏–±–∫–∞';
                refs.status.className = 'status-badge warning';
                showToast(error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É');
            }
        }

        async function loadQueue() {
            try {
                const payload = await fetchJson(API_QUEUE);
                renderQueue(payload.items || []);
            } catch (error) {
                console.error(error);
                refs.queueBlock.innerHTML = '<div class="queue-empty">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—á–µ—Ä–µ–¥—å.</div>';
            }
        }

        function exportStructure() {
            if (!state.structure) {
                showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }
            const payload = {
                generated_at: new Date().toISOString(),
                structure: state.structure,
                stats: state.stats,
                viewport: {
                    zoom: state.zoom,
                    pan: { x: state.panX, y: state.panY },
                },
            };
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `structure_export_${Date.now()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            showToast('–≠–∫—Å–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω');
        }

        document.getElementById('btn-reload').addEventListener('click', () => {
            loadStructure();
            loadQueue();
        });
        document.getElementById('btn-refresh-queue').addEventListener('click', loadQueue);
        document.getElementById('btn-export').addEventListener('click', exportStructure);
        document.getElementById('btn-zoom-in').addEventListener('click', () => { state.zoom = Math.min(2, state.zoom + 0.1); applyTransform(); });
        document.getElementById('btn-zoom-out').addEventListener('click', () => { state.zoom = Math.max(0.3, state.zoom - 0.1); applyTransform(); });
        document.getElementById('btn-zoom-reset').addEventListener('click', fitToView);
        document.getElementById('btn-fit').addEventListener('click', fitToView);
        document.getElementById('btn-center').addEventListener('click', () => {
            state.panX = 0;
            state.panY = 0;
            applyTransform();
        });
        refs.canvas.addEventListener('wheel', event => {
            event.preventDefault();
            const factor = event.deltaY < 0 ? 1.1 : 0.9;
            state.zoom = Math.min(2, Math.max(0.3, state.zoom * factor));
            applyTransform();
        }, { passive: false });

        document.addEventListener('DOMContentLoaded', () => {
            loadStructure();
            loadQueue();
        });
    </script>
</body>
</html>

