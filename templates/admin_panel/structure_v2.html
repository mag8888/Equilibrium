<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ v2 ‚Äî –°–µ—Ç–∫–∞, –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: #1f2937; }
        .toolbar { position: fixed; top: 10px; left: 10px; z-index: 1000; display: flex; gap: 8px; background: rgba(255,255,255,0.9); padding: 8px 10px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); }
        .stats-panel { position: fixed; top: 10px; right: 10px; z-index: 1000; background: rgba(255,255,255,0.95); padding: 12px 16px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); min-width: 200px; }
        .stats-title { font-weight: 600; margin-bottom: 8px; font-size: 14px; color: #333; }
        .stats-item { display: flex; justify-content: space-between; padding: 4px 0; font-size: 13px; border-bottom: 1px solid #eee; }
        .stats-item:last-child { border-bottom: none; }
        .stats-level { color: #666; }
        .stats-count { font-weight: 600; color: #2563eb; }
        .btn { padding: 6px 10px; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; color: #1f2937; font-weight: 500; }
        .btn:hover { background: #f3f4f6; }
        .viewport { position: relative; width: 100vw; height: 100vh; overflow: hidden; background: #fafafa; }
        .canvas { position: absolute; top: 0; left: 0; width: 6500px; height: 8450px; transform-origin: 0 0; }
        .grid { position: absolute; inset: 0; background-image: linear-gradient(#eee 1px, transparent 1px), linear-gradient(90deg, #eee 1px, transparent 1px); background-size: 40px 40px, 40px 40px; pointer-events: none; }
        .grid.heavy { background-image: linear-gradient(#eee 1px, transparent 1px), linear-gradient(90deg, #eee 1px, transparent 1px), linear-gradient(#e2e8f0 1px, transparent 1px), linear-gradient(90deg, #e2e8f0 1px, transparent 1px); background-size: 40px 40px, 40px 40px, 200px 200px, 200px 200px; }
        .links { position: absolute; inset: 0; pointer-events: none; }
        .link-path { fill: none; stroke: #2563eb; stroke-width: 4; opacity: 0.9; }
        .link-shadow { fill: none; stroke: rgba(37,99,235,0.25); stroke-width: 8; }
        .card { position: absolute; min-width: 140px; min-height: 64px; padding: 10px 12px; background: white; border: 2px solid #cbd5e1; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); cursor: grab; user-select: none; transition: box-shadow 0.15s ease; color: #1f2937; }
        .card:hover { box-shadow: 0 6px 18px rgba(0,0,0,0.1); }
        .card.dragging { cursor: grabbing; z-index: 2000; }
        .card .badge { position: absolute; top: -10px; left: -10px; background: #1f2937; color: #fff; font-size: 11px; padding: 2px 6px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
        .card .name { font-weight: 600; color: #1f2937; }
        .card .uid { font-size: 12px; opacity: 0.6; color: #4b5563; }
        .point { position: absolute; width: 12px; height: 12px; border-radius: 50%; background: #22c55e; border: 2px solid #16a34a; top: 50%; transform: translateY(-50%); cursor: pointer; }
        .point.left { left: -8px; }
        .point.right { right: -8px; }
        .point.disabled { background: #e5e7eb; border-color: #cbd5e1; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="toolbar">
        <button class="btn" id="toggleGrid">–°–∫—Ä—ã—Ç—å —Å–µ—Ç–∫—É</button>
        <button class="btn" id="center">–¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="btn" id="snap">–ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Ç–∫–µ: –í–∫–ª</button>
        <button class="btn" id="zoomOut">‚àí</button>
        <button class="btn" id="zoomIn">+</button>
        <button class="btn" id="autoLayout" style="background: #10b981; color: white;">üìê –†–∞—Å—Å—Ç–∞–≤–∏—Ç—å</button>
    </div>
    <div class="stats-panel" id="statsPanel">
        <div class="stats-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—è–º</div>
        <div id="statsContent"></div>
    </div>
    <div class="viewport" id="viewport">
        <div class="canvas" id="canvas">
            <div class="grid heavy" id="grid"></div>
            <svg class="links" id="links" width="6500" height="8450"></svg>
            <!-- –ê–≤—Ç–æ-—Ä–∞—Å–∫–ª–∞–¥–∫–∞ –ø—Ä–∏–º–µ—Ä–∞ –ø–æ —É—Ä–æ–≤–Ω—è–º -->
            <div class="card" data-id="root" data-level="0" data-name="IVA" data-uid="0000001" style="left: 2400px; top: 200px;"></div>
        </div>
    </div>

    <script>
        const GRID_SIZE = 40;
        const viewport = document.getElementById('viewport');
        // –†–µ–Ω–¥–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∫–∞—Ä—Ç–æ—á–∫–∏ (–∏–º—è, id, –±–µ–π–¥–∂ —É—Ä–æ–≤–Ω—è)
        function renderCardContents(card) {
            const depth = parseInt(card.dataset.level || '0');
            const displayLevel = Math.max(0, 5 - depth); // 5 —É –∫–æ—Ä–Ω—è, –¥–æ 0 —É –Ω–∏–∂–Ω–∏—Ö
            if (!card.dataset.name) card.dataset.name = generateRandomName();
            if (!card.dataset.uid) card.dataset.uid = generateRandomId();
            card.innerHTML = `
                <div class="badge">${displayLevel}</div>
                <div class="name">${card.dataset.name}</div>
                <div class="uid">ID${card.dataset.uid}</div>
            `;
        }
        function generateRandomId() { return String(Math.floor(1000000 + Math.random()*9000000)); }
        function generateRandomName() {
            const first = ['Alex','Ivan','Olga','Anna','Max','Nina','Oleg','Ilya','Vera','Mira','Dima','Pavel'];
            const last = ['Petrov','Sidorov','Morozov','Kuznetsov','Smirnov','Volkov','Lebedev','Antonov'];
            return first[Math.floor(Math.random()*first.length)] + ' ' + last[Math.floor(Math.random()*last.length)];
        }
        const canvas = document.getElementById('canvas');
        const grid = document.getElementById('grid');
        const links = document.getElementById('links');
        const btnGrid = document.getElementById('toggleGrid');
        const btnCenter = document.getElementById('center');
        const btnSnap = document.getElementById('snap');
        const btnZoomIn = document.getElementById('zoomIn');
        const btnZoomOut = document.getElementById('zoomOut');
        const btnAutoLayout = document.getElementById('autoLayout');
        const statsContent = document.getElementById('statsContent');

        let scale = 1; // 0.5..2
        let offsetX = 0; // –ø–∞–Ω–æ—Ä–∞–º–∞
        let offsetY = 0;
        let isPanning = false;
        let panStartX = 0, panStartY = 0;
        let canvasStartX = 0, canvasStartY = 0;
        let snapEnabled = true;

        function clampOffsets() {
            const canvasW = 6500 * scale;
            const canvasH = 8450 * scale;
            const minX = Math.min(0, viewport.clientWidth - canvasW);
            const minY = Math.min(0, viewport.clientHeight - canvasH);
            const maxX = 0;
            const maxY = 0;
            offsetX = Math.max(minX, Math.min(maxX, offsetX));
            offsetY = Math.max(minY, Math.min(maxY, offsetY));
        }
        function applyTransform() {
            clampOffsets();
            canvas.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
        }

        // –ü–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –ø—É—Å—Ç–æ–º—É –º–µ—Å—Ç—É
        viewport.addEventListener('mousedown', (e) => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –Ω–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –∏–ª–∏ –µ—ë –¥–æ—á–µ—Ä–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–∞—Ö
            if (e.target.closest('.card')) return;
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ –∏–¥–µ—Ç drag –∫–∞—Ä—Ç–æ—á–∫–∏
            if (dragging) return;
            isPanning = true;
            panStartX = e.clientX;
            panStartY = e.clientY;
            canvasStartX = offsetX;
            canvasStartY = offsetY;
        });
        window.addEventListener('mousemove', (e) => {
            // –ï—Å–ª–∏ –∏–¥–µ—Ç drag –∫–∞—Ä—Ç–æ—á–∫–∏, –Ω–µ –ø–∞–Ω–æ—Ä–∞–º–∏—Ä—É–µ–º
            if (dragging) {
                isPanning = false;
                return;
            }
            if (!isPanning) return;
            offsetX = canvasStartX + (e.clientX - panStartX);
            offsetY = canvasStartY + (e.clientY - panStartY);
            applyTransform();
        });
        window.addEventListener('mouseup', () => { 
            isPanning = false;
        });

        // –ó—É–º –∫–æ–ª—ë—Å–∏–∫–æ–º
        viewport.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY < 0 ? 1.1 : 0.9;
            const prevScale = scale;
            scale = Math.min(2, Math.max(0.5, scale * delta));
            // –ú–∞—Å—à—Ç–∞–± –≤–æ–∫—Ä—É–≥ –∫—É—Ä—Å–æ—Ä–∞
            const rect = viewport.getBoundingClientRect();
            const cx = e.clientX - rect.left;
            const cy = e.clientY - rect.top;
            offsetX = cx - (cx - offsetX) * (scale / prevScale);
            offsetY = cy - (cy - offsetY) * (scale / prevScale);
            applyTransform();
        }, { passive: false });

        btnZoomIn.onclick = () => { scale = Math.min(2, scale * 1.1); applyTransform(); };
        btnZoomOut.onclick = () => { scale = Math.max(0.5, scale * 0.9); applyTransform(); };
        btnCenter.onclick = () => {
            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª–æ—Ç–Ω–æ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ –∏ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
            offsetX = (viewport.clientWidth - 6500 * scale) / 2;
            offsetY = (viewport.clientHeight - 8450 * scale) / 2;
            applyTransform();
        };
        btnAutoLayout.onclick = () => autoLayoutCards();

        // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–µ—Ç–∫–∏
        let gridVisible = true;
        btnGrid.onclick = () => {
            gridVisible = !gridVisible;
            grid.style.display = gridVisible ? 'block' : 'none';
            btnGrid.textContent = gridVisible ? '–°–∫—Ä—ã—Ç—å —Å–µ—Ç–∫—É' : '–ü–æ–∫–∞–∑–∞—Ç—å —Å–µ—Ç–∫—É';
        };
        btnSnap.onclick = () => {
            snapEnabled = !snapEnabled;
            btnSnap.textContent = `–ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Ç–∫–µ: ${snapEnabled ? '–í–∫–ª' : '–í—ã–∫–ª'}`;
        };

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ: –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä id –∏ —Ä–∞–±–æ—Ç–∞ —Å –¥–µ—Ç—å–º–∏
        const childMap = new Map(); // parentId -> Set(childIds)
        let uidCounter = 1;
        function genId() { return 'node-' + (uidCounter++); }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π
        const STORAGE_KEY = 'structure_v2_positions';
        function savePositions() {
            const cards = Array.from(canvas.querySelectorAll('.card'));
            const data = {
                uidCounter,
                cards: cards.map(card => ({
                    id: card.dataset.id,
                    parent: card.dataset.parent || null,
                    left: parseInt(card.style.left) || 0,
                    top: parseInt(card.style.top) || 0,
                    level: parseInt(card.dataset.level || '0'),
                    name: card.dataset.name || '',
                    uid: card.dataset.uid || ''
                })),
                childMap: Array.from(childMap.entries()).map(([parent, children]) => [parent, Array.from(children)])
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }
        function loadPositions() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return false;
            try {
                const data = JSON.parse(saved);
                uidCounter = data.uidCounter || 1;
                // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
                canvas.querySelectorAll('.card').forEach(card => card.remove());
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º childMap
                childMap.clear();
                if (data.childMap) {
                    data.childMap.forEach(([parent, children]) => {
                        childMap.set(parent, new Set(children));
                    });
                }
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
                const cardMap = new Map();
                data.cards.forEach(item => {
                    let card = canvas.querySelector(`.card[data-id="${item.id}"]`);
                    if (!card) {
                        card = document.createElement('div');
                        card.className = 'card';
                        card.dataset.id = item.id;
                        canvas.appendChild(card);
                    }
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∞—Ç—Ä–∏–±—É—Ç—ã
                    if (item.parent) card.dataset.parent = item.parent;
                    if (typeof item.level === 'number') card.dataset.level = String(item.level);
                    if (item.name) card.dataset.name = item.name;
                    if (item.uid) card.dataset.uid = item.uid;
                    card.style.left = item.left + 'px';
                    card.style.top = item.top + 'px';
                    // –†–µ–Ω–¥–µ—Ä–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                    renderCardContents(card);
                    // –í–∫–ª—é—á–∞–µ–º drag –∏ —Ç–æ—á–∫–∏
                    enableDrag(card);
                    cardMap.set(item.id, card);
                });
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ—á–µ–∫
                cardMap.forEach(card => {
                    updatePointsState(card);
                });
                updateAllConnections();
                updateStats();
                return true;
            } catch (e) {
                console.error('Failed to load positions:', e);
                return false;
            }
        }
        function getChildSet(parentId) {
            if (!childMap.has(parentId)) childMap.set(parentId, new Set());
            return childMap.get(parentId);
        }
        function updatePointsState(card) {
            const pid = card.dataset.id;
            const count = (getChildSet(pid)).size;
            const disabled = count >= 3;
            card.querySelectorAll('.point').forEach(p => p.classList.toggle('disabled', disabled));
        }
        function attachPoints(card) {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ç–æ—á–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
            card.querySelectorAll('.point').forEach(p => p.remove());
            const left = document.createElement('div'); left.className = 'point left'; left.title = '–î–æ–±–∞–≤–∏—Ç—å —Å–ª–µ–≤–∞';
            const right = document.createElement('div'); right.className = 'point right'; right.title = '–î–æ–±–∞–≤–∏—Ç—å —Å–ø—Ä–∞–≤–∞';
            left.addEventListener('click', (e) => { e.stopPropagation(); createChild(card, 'left'); });
            right.addEventListener('click', (e) => { e.stopPropagation(); createChild(card, 'right'); });
            card.appendChild(left); card.appendChild(right);
            updatePointsState(card);
        }

        function createChild(parentCard, side) {
            const parentId = parentCard.dataset.id;
            const children = getChildSet(parentId);
            if (children.size >= 3) return; // –ª–∏–º–∏—Ç

            const id = genId();
            const child = document.createElement('div');
            child.className = 'card';
            child.dataset.id = id;
            child.dataset.parent = parentId;
            child.dataset.level = String((parseInt(parentCard.dataset.level || '0')) + 1);
            const px = parseInt(parentCard.style.left) || 0;
            const py = parseInt(parentCard.style.top) || 0;
            const index = children.size; // 0..2
            // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞ –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è
            const horizontalOffset = side === 'left' ? -240 : 240;
            // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ —É—Ä–æ–≤–Ω–∏: –ø–µ—Ä–≤—ã–π –≤—ã—à–µ, –≤—Ç–æ—Ä–æ–π –ø–æ —Ü–µ–Ω—Ç—Ä—É, —Ç—Ä–µ—Ç–∏–π –Ω–∏–∂–µ
            // –ë–µ—Ä—ë–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ä–µ–±—ë–Ω–∫–∞, –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –¥–µ—Ñ–æ–ª—Ç 120
            let dy = 120;
            const existing = Array.from(canvas.querySelectorAll(`.card[data-parent="${parentId}"]`));
            if (existing.length > 0) {
                const base = py + 200;
                // –ë–µ—Ä—ë–º —Å–º–µ—â–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–±—ë–Ω–∫–∞ (–ø–æ –º–æ–¥—É–ª—é)
                const firstChild = existing[0];
                const firstOffset = Math.abs((parseInt(firstChild.style.top) || 0) - base);
                if (firstOffset > 0) dy = Math.max(40, Math.min(240, firstOffset));
            }
            const verticalLevels = [-dy, 0, dy]; // –≤—ã—à–µ, —Ü–µ–Ω—Ç—Ä, –Ω–∏–∂–µ
            const baseY = py + 200;
            const vy = verticalLevels[Math.min(index, 2)];
            const nx = px + horizontalOffset + (side === 'left' ? -index * 0 : 0);
            const ny = baseY + vy;
            // –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Ç–∫–µ
            const snappedX = Math.round(nx / GRID_SIZE) * GRID_SIZE;
            const snappedY = Math.round(ny / GRID_SIZE) * GRID_SIZE;
            child.style.left = snappedX + 'px';
            child.style.top = snappedY + 'px';
            renderCardContents(child);
            canvas.appendChild(child);
            attachPoints(child);
            enableDrag(child);
            children.add(id);
            updatePointsState(parentCard);
            updateConnectionFor(child);
            savePositions();
            updateStats();
        }

        // Drag –∫–∞—Ä—Ç–æ—á–µ–∫
        let dragging = null;
        let dragOffsetX = 0, dragOffsetY = 0;
        let startLeft = 0, startTop = 0;

        function toCanvasCoords(clientX, clientY) {
            const rect = viewport.getBoundingClientRect();
            const x = (clientX - rect.left - offsetX) / scale;
            const y = (clientY - rect.top - offsetY) / scale;
            return { x, y };
        }

        function enableDrag(card) {
            attachPoints(card);
            card.addEventListener('mousedown', (e) => {
                if ((e.target).classList && (e.target).classList.contains('point')) return;
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ drag –∫–∞—Ä—Ç–æ—á–∫–∏
                isPanning = false;
                dragging = card;
                dragging.classList.add('dragging');
                const { x, y } = toCanvasCoords(e.clientX, e.clientY);
                startLeft = parseInt(card.style.left) || 0;
                startTop = parseInt(card.style.top) || 0;
                dragOffsetX = x - startLeft;
                dragOffsetY = y - startTop;
                e.preventDefault();
                e.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
            });
        }

        window.addEventListener('mousemove', (e) => {
            if (!dragging) return;
            const { x, y } = toCanvasCoords(e.clientX, e.clientY);
            const nx = x - dragOffsetX;
            const ny = y - dragOffsetY;
            dragging.style.left = nx + 'px';
            dragging.style.top = ny + 'px';
            updateConnectionsForCardAndRelatives(dragging);
        });
        window.addEventListener('mouseup', () => {
            if (!dragging) return;
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ
            isPanning = false;
            if (snapEnabled) {
                const nx = Math.round((parseInt(dragging.style.left) || 0) / GRID_SIZE) * GRID_SIZE;
                const ny = Math.round((parseInt(dragging.style.top) || 0) / GRID_SIZE) * GRID_SIZE;
                dragging.style.left = nx + 'px';
                dragging.style.top = ny + 'px';
            }
            dragging.classList.remove('dragging');
            const finished = dragging;
            dragging = null;
            if (finished) {
                updateConnectionsForCardAndRelatives(finished);
                savePositions();
                updateStats();
            }
        });

        // –°—Ç–∞—Ä—Ç: –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
        if (!loadPositions()) {
            // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, —É–¥–∞–ª—è–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫—Ä–æ–º–µ root
            canvas.querySelectorAll('.card').forEach(card => {
                if (card.dataset.id !== 'root') {
                    card.remove();
                }
            });
            // –û—á–∏—â–∞–µ–º childMap
            childMap.clear();
            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º root –∫–∞—Ä—Ç–æ—á–∫—É
            const root = canvas.querySelector('.card[data-id="root"]');
            if (root) {
                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —É root –µ—Å—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã
                if (!root.dataset.level) root.dataset.level = '0';
                if (!root.dataset.name) root.dataset.name = 'IVA';
                if (!root.dataset.uid) root.dataset.uid = '0000001';
                renderCardContents(root);
                enableDrag(root);
            }
        }
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω—ã
        canvas.querySelectorAll('.card').forEach(card => {
            if (!card.querySelector('.badge')) {
                renderCardContents(card);
            }
        });
        btnCenter.click();
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        updateStats();

        // ----- –°–≤—è–∑–∏ (–∫–∞–∫ –≤ Miro): –≥–∏–±–∫–∏–µ –∫—Ä–∏–≤—ã–µ, —Å–ª–µ–¥—É—é—Ç –∑–∞ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ -----
        function getAnchorRight(card) {
            const left = parseInt(card.style.left) || 0;
            const top = parseInt(card.style.top) || 0;
            const w = Math.max(card.offsetWidth, 140);
            const h = Math.max(card.offsetHeight, 64);
            return { x: left + w, y: top + h / 2 };
        }
        function getAnchorLeft(card) {
            const left = parseInt(card.style.left) || 0;
            const top = parseInt(card.style.top) || 0;
            return { x: left, y: top + (Math.max(card.offsetHeight, 64) / 2) };
        }
        function pathCubic(start, end) {
            const dx = Math.max(40, Math.abs(end.x - start.x) * 0.5);
            const c1 = { x: start.x + dx, y: start.y };
            const c2 = { x: end.x - dx, y: end.y };
            return `M ${start.x} ${start.y} C ${c1.x} ${c1.y}, ${c2.x} ${c2.y}, ${end.x} ${end.y}`;
        }
        function ensureLinkPath(id) {
            let g = document.getElementById('link-' + id);
            if (!g) {
                g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('id', 'link-' + id);
                const shadow = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                shadow.setAttribute('class', 'link-shadow');
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('class', 'link-path');
                g.appendChild(shadow);
                g.appendChild(path);
                links.appendChild(g);
            }
            return g;
        }
        function updateConnectionFor(childCard) {
            const parentId = childCard.dataset.parent;
            if (!parentId) return;
            const parentCard = canvas.querySelector(`.card[data-id="${parentId}"]`);
            if (!parentCard) return;
            const start = getAnchorRight(parentCard);
            const end = getAnchorLeft(childCard);
            const d = pathCubic(start, end);
            const g = ensureLinkPath(childCard.dataset.id);
            g.firstChild.setAttribute('d', d);
            g.lastChild.setAttribute('d', d);
        }
        function updateConnectionsForCardAndRelatives(card) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤—è–∑—å –∫ —Ä–æ–¥–∏—Ç–µ–ª—é
            updateConnectionFor(card);
            // –ò —Å–≤—è–∑–∏ –∫–æ –≤—Å–µ–º –¥–µ—Ç—è–º
            const id = card.dataset.id;
            canvas.querySelectorAll(`.card[data-parent="${id}"]`).forEach(updateConnectionFor);
        }
        function updateAllConnections() {
            canvas.querySelectorAll('.card[data-parent]').forEach(updateConnectionFor);
        }
        // –Ω–∞—á–∞–ª—å–Ω–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ (–¥–ª—è root –¥–µ—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç)
        updateAllConnections();

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ –±–µ–∑ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π
        function autoLayoutCards() {
            const cards = Array.from(canvas.querySelectorAll('.card'));
            if (cards.length === 0) return;
            
            const CARD_WIDTH = 160;
            const CARD_HEIGHT = 80;
            const HORIZONTAL_GAP = 300; // –ë–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π
            const VERTICAL_GAP = 350; // –ë–æ–ª—å—à–æ–π –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –¥–ª—è –ª–∏–Ω–∏–π
            const SAFETY_MARGIN = 50; // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π
            const START_Y = 500;
            
            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ ID
            const cardMap = new Map();
            cards.forEach(card => {
                cardMap.set(card.dataset.id, card);
            });
            
            // –°—Ç—Ä–æ–∏–º –¥–µ—Ä–µ–≤–æ —Å–≤—è–∑–µ–π
            const childrenMap = new Map();
            cards.forEach(card => {
                const parentId = card.dataset.parent || 'root';
                if (!childrenMap.has(parentId)) {
                    childrenMap.set(parentId, []);
                }
                childrenMap.get(parentId).push(card);
            });
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ —É—Ä–æ–≤–Ω—è–º
            const cardsByLevel = {};
            cards.forEach(card => {
                const depth = parseInt(card.dataset.level || '0');
                if (!cardsByLevel[depth]) cardsByLevel[depth] = [];
                cardsByLevel[depth].push(card);
            });
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —É—Ä–æ–≤–Ω–∏ –æ—Ç –º–µ–Ω—å—à–µ–≥–æ –∫ –±–æ–ª—å—à–µ–º—É
            const sortedLevels = Object.keys(cardsByLevel).sort((a, b) => parseInt(a) - parseInt(b));
            
            // –•—Ä–∞–Ω–∏–º –≤—Å–µ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π
            const allPlacedRects = [];
            
            // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ —Å —É–∂–µ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–º–∏
            function hasCollision(rect, excludeCard = null) {
                for (const placed of allPlacedRects) {
                    if (excludeCard && placed.card === excludeCard) continue;
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å –æ—Ç—Å—Ç—É–ø–æ–º
                    if (!(rect.right + SAFETY_MARGIN < placed.left || 
                          rect.left - SAFETY_MARGIN > placed.right ||
                          rect.bottom + SAFETY_MARGIN < placed.top || 
                          rect.top - SAFETY_MARGIN > placed.bottom)) {
                        return true;
                    }
                }
                return false;
            }
            
            // –†–∞–∑–º–µ—â–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ —É—Ä–æ–≤–Ω—è–º
            sortedLevels.forEach(level => {
                const levelCards = cardsByLevel[level];
                const levelNum = parseInt(level);
                const y = START_Y + levelNum * VERTICAL_GAP;
                
                if (levelNum === 0) {
                    // Root –∫–∞—Ä—Ç–æ—á–∫–∞ - —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º
                    const root = levelCards[0];
                    const rootX = Math.round((6500 / 2 - CARD_WIDTH / 2) / GRID_SIZE) * GRID_SIZE;
                    root.style.left = rootX + 'px';
                    root.style.top = Math.round(y / GRID_SIZE) * GRID_SIZE + 'px';
                    allPlacedRects.push({
                        card: root,
                        left: rootX,
                        right: rootX + CARD_WIDTH,
                        top: y,
                        bottom: y + CARD_HEIGHT
                    });
                } else {
                    // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π —Ä–∞–∑–º–µ—â–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ –ø–æ–∑–∏—Ü–∏–∏ —Ä–æ–¥–∏—Ç–µ–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å) –¥–ª—è –±–æ–ª–µ–µ –ª–æ–≥–∏—á–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞
                    levelCards.sort((a, b) => {
                        const aParentId = a.dataset.parent || 'root';
                        const bParentId = b.dataset.parent || 'root';
                        const aParent = cardMap.get(aParentId);
                        const bParent = cardMap.get(bParentId);
                        
                        if (aParent && bParent) {
                            const aX = parseInt(aParent.style.left) || 0;
                            const bX = parseInt(bParent.style.left) || 0;
                            if (aX !== bX) return aX - bX;
                        }
                        // –ï—Å–ª–∏ —Ä–æ–¥–∏—Ç–µ–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∏–ª–∏ –Ω–µ—Ç, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ ID
                        return (a.dataset.id || '').localeCompare(b.dataset.id || '');
                    });
                    
                    // –†–∞–∑–º–µ—â–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
                    let currentX = 200;
                    
                    levelCards.forEach(child => {
                        let cardX = currentX;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –∏ —Å–¥–≤–∏–≥–∞–µ–º –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
                        let attempts = 0;
                        let hasOverlap = true;
                        while (hasOverlap && attempts < 200) {
                            const testRect = {
                                left: cardX,
                                right: cardX + CARD_WIDTH,
                                top: y,
                                bottom: y + CARD_HEIGHT
                            };
                            
                            if (hasCollision(testRect)) {
                                cardX += HORIZONTAL_GAP / 2;
                                attempts++;
                            } else {
                                hasOverlap = false;
                            }
                        }
                        
                        // –†–∞–∑–º–µ—â–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
                        const x = Math.round(cardX / GRID_SIZE) * GRID_SIZE;
                        child.style.left = x + 'px';
                        child.style.top = Math.round(y / GRID_SIZE) * GRID_SIZE + 'px';
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö
                        allPlacedRects.push({
                            card: child,
                            left: x,
                            right: x + CARD_WIDTH,
                            top: y,
                            bottom: y + CARD_HEIGHT
                        });
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∫–∞—Ä—Ç–æ—á–∫–∏
                        currentX = x + CARD_WIDTH + HORIZONTAL_GAP;
                    });
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤—è–∑–∏ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
            updateAllConnections();
            savePositions();
            updateStats();
        }

        // –ü–æ–¥—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —É—Ä–æ–≤–Ω—è–º
        function updateStats() {
            const cards = Array.from(canvas.querySelectorAll('.card'));
            const levelCounts = {};
            cards.forEach(card => {
                const depth = parseInt(card.dataset.level || '0');
                const displayLevel = Math.max(0, 5 - depth);
                levelCounts[displayLevel] = (levelCounts[displayLevel] || 0) + 1;
            });
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —É—Ä–æ–≤–Ω–∏ –æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É
            const sortedLevels = Object.keys(levelCounts).sort((a, b) => parseInt(b) - parseInt(a));
            let html = '';
            sortedLevels.forEach(level => {
                html += `<div class="stats-item"><span class="stats-level">–£—Ä–æ–≤–µ–Ω—å ${level}:</span><span class="stats-count">${levelCounts[level]}</span></div>`;
            });
            if (sortedLevels.length === 0) {
                html = '<div class="stats-item">–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫</div>';
            }
            statsContent.innerHTML = html;
        }

        // –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫—Ä–æ–º–µ root –∏ —Å–±—Ä–æ—Å–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        function resetToRoot() {
            // –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—â–∞–µ–º localStorage, —á—Ç–æ–±—ã –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–µ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å –∫–∞—Ä—Ç–æ—á–∫–∏
            localStorage.removeItem(STORAGE_KEY);
            
            // –ù–∞—Ö–æ–¥–∏–º root –∫–∞—Ä—Ç–æ—á–∫—É
            const root = canvas.querySelector('.card[data-id="root"]');
            const rootId = root ? root.dataset.id : null;
            
            // –£–¥–∞–ª—è–µ–º –í–°–ï –∫–∞—Ä—Ç–æ—á–∫–∏ –∫—Ä–æ–º–µ root
            const allCards = Array.from(canvas.querySelectorAll('.card'));
            allCards.forEach(card => {
                if (card && card.dataset.id !== rootId) {
                    card.remove();
                }
            });
            
            // –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Å–≤—è–∑–∏
            links.innerHTML = '';
            
            // –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            childMap.clear();
            uidCounter = 1;
            
            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å root –∫–∞—Ä—Ç–æ—á–∫—É
            if (root) {
                root.dataset.level = '0';
                root.dataset.parent = '';
                renderCardContents(root);
                // –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ç–æ—á–∫–∏ –∏ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ
                root.querySelectorAll('.point').forEach(p => p.remove());
                attachPoints(root);
                enableDrag(root);
            }
            
            // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—Ç–æ–ª—å–∫–æ root)
            savePositions();
            updateAllConnections();
            updateStats();
        }
    </script>
</body>
</html>


