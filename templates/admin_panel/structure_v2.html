<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ v2 ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º–∏</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f4f6fb;
            color: #1f2937;
        }
        .layout {
            display: grid;
            grid-template-columns: minmax(0, 1fr) 320px;
            grid-template-rows: auto 1fr;
            grid-template-areas: "header header" "canvas sidebar";
            min-height: 100vh;
        }
        header {
            grid-area: header;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 16px 24px;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.05);
        }
        header .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 16px;
        }
        .controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        button {
            border: 1px solid #d1d5db;
            background: #fff;
            color: #1f2937;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s ease, box-shadow 0.15s ease;
        }
        button.primary {
            background: #2563eb;
            color: #fff;
            border-color: transparent;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        button:not(:disabled):hover {
            background: #f8fafc;
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
        }
        main {
            grid-area: canvas;
            padding: 16px 24px 24px 24px;
        }
        .canvas-container {
            background: linear-gradient(180deg, #ffffff, #f4f6fb);
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            height: calc(100vh - 120px);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .canvas-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            background: rgba(255,255,255,0.85);
        }
        #canvas {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-image: linear-gradient(#e5e7eb 1px, transparent 1px), linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
            background-size: 40px 40px;
        }
        #canvasInner {
            position: absolute;
            inset: 0;
            transform-origin: 0 0;
        }
        svg#connections {
            position: absolute;
            inset: 0;
            transform-origin: 0 0;
        }
        .card {
            position: absolute;
            background: #fff;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            padding: 12px 14px;
            min-width: 170px;
            box-shadow: 0 10px 30px rgba(15,23,42,0.12);
            transform: translate(-50%, -50%);
        }
        .card .title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .card .subtitle {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
        .card .stats {
            margin-top: 8px;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 6px;
            font-size: 11px;
            color: #475569;
        }
        aside {
            grid-area: sidebar;
            padding: 16px 24px 24px 0;
        }
        .sidebar-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
        }
        .sidebar-card h3 {
            margin: 0 0 12px;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .stats-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            font-size: 13px;
        }
        .queue-empty {
            text-align: center;
            color: #94a3b8;
            font-style: italic;
        }
        .queue-item {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 10px 12px;
            background: linear-gradient(180deg, #ffffff, #f8fafc);
            display: grid;
            gap: 6px;
            margin-bottom: 10px;
            font-size: 13px;
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 10px;
            border-radius: 999px;
            background: rgba(37, 99, 235, 0.12);
            color: #2563eb;
            font-size: 12px;
            font-weight: 600;
        }
        .status-badge.success {
            background: rgba(16, 185, 129, 0.15);
            color: #047857;
        }
        .status-badge.warning {
            background: rgba(251, 191, 36, 0.18);
            color: #b45309;
        }
        .toast {
            position: fixed;
            right: 24px;
            bottom: 24px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.18);
            display: none;
            min-width: 220px;
        }
        .toast.show { display: block; }
        footer {
            grid-column: 1 / -1;
            padding: 12px 24px;
            font-size: 12px;
            color: #6b7280;
            background: #ffffff;
            border-top: 1px solid #e5e7eb;
            text-align: right;
        }
        @media (max-width: 1200px) {
            .layout {
                grid-template-columns: 1fr;
                grid-template-areas: "header" "canvas" "sidebar";
            }
            aside {
                padding: 0 24px 24px;
            }
        }
    </style>
</head>
<body>
    <div class="layout">
        <header>
            <div class="brand">‚öôÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ ¬∑ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</div>
            <div class="controls">
                <button id="btn-reload" class="primary">‚ü≥ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                <button id="btn-fit">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë</button>
                <button id="btn-center">–¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                <button id="btn-export">–≠–∫—Å–ø–æ—Ä—Ç</button>
            </div>
        </header>

        <main>
            <div class="canvas-container">
                <div class="canvas-toolbar">
                    <div class="status-badge" id="status-badge">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
                    <div class="controls" style="gap:6px;">
                        <button id="btn-zoom-out">‚àí</button>
                        <button id="btn-zoom-reset">100%</button>
                        <button id="btn-zoom-in">+</button>
                    </div>
                </div>
                <div id="canvas">
                    <svg id="connections"></svg>
                    <div id="canvasInner"></div>
                    <div class="queue-empty" id="canvas-loader" style="position:absolute; inset:0; display:grid; place-items:center; background: rgba(255,255,255,0.6);">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã‚Ä¶</div>
                </div>
            </div>
        </main>

        <aside>
            <div class="sidebar-card" id="stats-card">
                <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div class="stats-list" id="stats-list">
                    <div class="queue-empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                </div>
                <div style="margin-top:12px; font-size:12px; color:#94a3b8;">–û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="stats-updated">‚Äî</span></div>
            </div>
            <div class="sidebar-card">
                <div class="controls" style="justify-content: space-between;">
                    <h3 style="margin:0;">üÜï –ù–æ–≤—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</h3>
                    <button id="btn-refresh-queue">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <div id="queue-block" style="margin-top:12px;">
                    <div class="queue-empty">–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.</div>
                </div>
            </div>
        </aside>

        <footer>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ MLM ¬∑ <span id="footer-status">‚Äî</span></footer>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const API_STRUCTURE = '/admin-panel/api/structure-data/';
        const API_QUEUE = '/api/mlm/registrations_queue/';

        const canvas = document.getElementById('canvas');
        const canvasInner = document.getElementById('canvasInner');
        const connectionLayer = document.getElementById('connections');
        const loader = document.getElementById('canvas-loader');
        const statusBadge = document.getElementById('status-badge');
        const statsList = document.getElementById('stats-list');
        const statsUpdated = document.getElementById('stats-updated');
        const queueBlock = document.getElementById('queue-block');
        const footerStatus = document.getElementById('footer-status');
        const toast = document.getElementById('toast');

        const state = {
            zoom: 1,
            panX: 0,
            panY: 0,
            contentWidth: 0,
            contentHeight: 0,
        };

        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2200);
        }

        async function fetchJson(url) {
            const response = await fetch(url, { headers: { 'Accept': 'application/json' } });
            if (!response.ok) {
                const text = await response.text();
                throw new Error(text || `HTTP ${response.status}`);
            }
            return response.json();
        }

        function ensureRoot(structure, stats) {
            if (!structure || !Array.isArray(structure.cards)) {
                return {
                    cards: [{
                        id: 'root',
                        parent: null,
                        name: (stats && stats.root && stats.root.name) || 'admin',
                        uid: (stats && stats.root && stats.root.username) || '0000001',
                        level: (stats && stats.root && stats.root.level) || 0,
                        directReferrals: (stats && stats.root && stats.root.direct_referrals) || 0,
                        totalReferrals: (stats && stats.root && stats.root.total_descendants) || 0,
                    }],
                    childMap: []
                };
            }
            const hasRoot = structure.cards.some(card => card && String(card.id) === 'root');
            if (!hasRoot) {
                const rootStats = stats && stats.root ? stats.root : {};
                structure.cards.unshift({
                    id: 'root',
                    parent: null,
                    name: rootStats.name || rootStats.username || 'admin',
                    uid: rootStats.username || '0000001',
                    level: rootStats.level || 0,
                    directReferrals: rootStats.direct_referrals || 0,
                    totalReferrals: rootStats.total_descendants || 0,
                });
            }
            if (!Array.isArray(structure.childMap)) {
                structure.childMap = [];
            }
            return structure;
        }

        function buildTree(structure) {
            const nodes = new Map();
            structure.cards.forEach(card => {
                if (!card) return;
                nodes.set(String(card.id), {
                    id: String(card.id),
                    parent: card.parent ? String(card.parent) : null,
                    name: card.name || card.username || '‚Äî',
                    uid: card.uid || card.username || '',
                    level: Number(card.level || card.displayLevel || 0),
                    direct: card.directReferrals != null ? card.directReferrals : 0,
                    total: card.totalReferrals != null ? card.totalReferrals : 0,
                    bonus: card.bonusYellow != null ? card.bonusYellow : 0,
                    children: [],
                });
            });
            structure.childMap.forEach(entry => {
                const parentId = String(entry[0]);
                const children = entry[1] || [];
                if (!nodes.has(parentId)) return;
                const parent = nodes.get(parentId);
                children.forEach(childId => {
                    const child = nodes.get(String(childId));
                    if (child) parent.children.push(child.id);
                });
            });
            let root = Array.from(nodes.values()).find(node => !node.parent) || nodes.get('root');
            if (!root && nodes.size > 0) root = Array.from(nodes.values())[0];
            return { nodes, rootId: root ? root.id : null };
        }

        function layoutTree(tree) {
            const positions = new Map();
            if (!tree.rootId) return positions;
            const GAP_X = 220;
            const GAP_Y = 140;
            let leaf = 0;
            function place(id, depth) {
                const node = tree.nodes.get(id);
                if (!node) return 0;
                if (!node.children.length) {
                    const x = leaf * GAP_X;
                    leaf += 1;
                    positions.set(id, { depth, x });
                    return x;
                }
                const xs = node.children.map(child => place(child, depth + 1));
                const avg = xs.reduce((a, b) => a + b, 0) / xs.length;
                positions.set(id, { depth, x: avg });
                return avg;
            }
            place(tree.rootId, 0);
            positions.forEach((pos, id) => {
                positions.set(id, { depth: pos.depth, x: pos.x, y: pos.depth * GAP_Y });
            });
            return positions;
        }

        function renderTree(structure) {
            canvasInner.innerHTML = '';
            connectionLayer.innerHTML = '';
            if (!structure.cards.length) {
                loader.style.display = 'grid';
                loader.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                return;
            }
            loader.style.display = 'none';
            const tree = buildTree(structure);
            const positions = layoutTree(tree);
            let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
            positions.forEach(({ x, y }) => {
                minX = Math.min(minX, x);
                maxX = Math.max(maxX, x);
                minY = Math.min(minY, y);
                maxY = Math.max(maxY, y);
            });
            const padding = 120;
            const width = (maxX - minX || 1) + padding * 2;
            const height = (maxY - minY || 1) + padding * 2;
            state.contentWidth = width;
            state.contentHeight = height;
            canvasInner.style.width = `${width}px`;
            canvasInner.style.height = `${height}px`;
            connectionLayer.setAttribute('viewBox', `0 0 ${width} ${height}`);
            connectionLayer.setAttribute('width', width);
            connectionLayer.setAttribute('height', height);
            const fragment = document.createDocumentFragment();
            positions.forEach((pos, id) => {
                const node = tree.nodes.get(id);
                if (!node) return;
                const left = pos.x - minX + padding;
                const top = pos.y - minY + padding;
                const el = document.createElement('div');
                el.className = 'card';
                el.style.left = `${left}px`;
                el.style.top = `${top}px`;
                el.innerHTML = `
                    <div class="title">${node.level === 0 ? 'üåê' : 'üë§'} ${node.name}</div>
                    <div class="subtitle">ID ${node.uid || '‚Äî'}</div>
                    <div class="stats">
                        <div>–£—Ä–æ–≤–µ–Ω—å: <strong>${node.level}</strong></div>
                        <div>–ü—Ä—è–º—ã—Ö: <strong>${node.direct}</strong></div>
                        <div>–í—Å–µ–≥–æ: <strong>${node.total}</strong></div>
                        <div>–ë–æ–Ω—É—Å: <strong>${node.bonus}</strong></div>
                    </div>`;
                fragment.appendChild(el);
            });
            canvasInner.appendChild(fragment);
            const svgNs = 'http://www.w3.org/2000/svg';
            tree.nodes.forEach(node => {
                if (!node.parent) return;
                const parentPos = positions.get(node.parent);
                const childPos = positions.get(node.id);
                if (!parentPos || !childPos) return;
                const startX = parentPos.x - minX + padding;
                const startY = parentPos.y - minY + padding;
                const endX = childPos.x - minX + padding;
                const endY = childPos.y - minY + padding;
                const dy = Math.max(60, (endY - startY) * 0.6);
                const path = document.createElementNS(svgNs, 'path');
                path.setAttribute('d',

